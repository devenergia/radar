# RAD-217: Componente MapaRoraima (Leaflet)

**Fase:** 5 - Frontend
**Tipo:** React Component
**Prioridade:** Alta
**Status:** PENDENTE
**Dependencias:** RAD-211, RAD-216
**Base Legal:** REN 1.137/2025 - Art. 106

## Objetivo

Criar componente de mapa interativo usando Leaflet para exibir interrupcoes.

## Localizacao

`frontend/src/components/MapaRoraima/MapaRoraima.tsx`

## Especificacao

### Funcionalidades

1. **Mapa Base:** Renderizar mapa de Roraima com tiles OpenStreetMap
2. **GeoJSON:** Renderizar limites dos municipios
3. **Marcadores:** Exibir interrupcoes como marcadores coloridos
4. **Popup:** Mostrar detalhes ao clicar no marcador
5. **Heat Map:** Colorir municipios por severidade
6. **Zoom/Pan:** Navegacao interativa
7. **Legenda:** Mostrar significado das cores

### Cores por Faixa

| Faixa | Cor |
|-------|-----|
| ATE_1H | #4CAF50 (Verde) |
| DE_1_A_3H | #8BC34A (Verde claro) |
| DE_3_A_6H | #FFEB3B (Amarelo) |
| DE_6_A_12H | #FF9800 (Laranja) |
| DE_12_A_24H | #FF5722 (Laranja escuro) |
| DE_24_A_48H | #F44336 (Vermelho) |
| MAIS_48H | #B71C1C (Vermelho escuro) |

## Implementacao

```typescript
// src/components/MapaRoraima/MapaRoraima.tsx
import { useEffect, useState } from 'react';
import {
  MapContainer,
  TileLayer,
  GeoJSON,
  Marker,
  Popup,
  useMap,
} from 'react-leaflet';
import L from 'leaflet';
import { useQuery } from '@tanstack/react-query';
import { mapaService } from '@/services/api';
import type { InterrupcaoMapa, FaixaDuracao } from '@/types';
import { Legenda } from './Legenda';
import 'leaflet/dist/leaflet.css';

// Centro de Roraima (Boa Vista)
const CENTRO_RORAIMA: [number, number] = [2.823841, -60.675833];
const ZOOM_INICIAL = 7;

// Cores por faixa
const CORES_FAIXA: Record<FaixaDuracao, string> = {
  ATE_1H: '#4CAF50',
  DE_1_A_3H: '#8BC34A',
  DE_3_A_6H: '#FFEB3B',
  DE_6_A_12H: '#FF9800',
  DE_12_A_24H: '#FF5722',
  DE_24_A_48H: '#F44336',
  MAIS_48H: '#B71C1C',
};

// Criar icone customizado
const criarIcone = (cor: string) =>
  L.divIcon({
    className: 'custom-marker',
    html: `
      <div style="
        background-color: ${cor};
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      "></div>
    `,
    iconSize: [24, 24],
    iconAnchor: [12, 12],
  });

interface MapaRoraimaProps {
  filtroMunicipio?: string;
  filtroFaixa?: FaixaDuracao;
  onInterrupcaoClick?: (interrupcao: InterrupcaoMapa) => void;
}

export function MapaRoraima({
  filtroMunicipio,
  filtroFaixa,
  onInterrupcaoClick,
}: MapaRoraimaProps) {
  // Buscar interrupcoes
  const { data: response, isLoading, error } = useQuery({
    queryKey: ['interrupcoes', filtroMunicipio, filtroFaixa],
    queryFn: () =>
      mapaService.getInterrupcoes({
        municipio: filtroMunicipio,
        faixa: filtroFaixa,
      }),
  });

  // Buscar GeoJSON dos municipios
  const { data: geojson } = useQuery({
    queryKey: ['municipios-geojson'],
    queryFn: () => mapaService.getMunicipiosGeojson(),
    staleTime: Infinity, // GeoJSON nao muda
  });

  const interrupcoes = response?.data ?? [];

  // Calcular severidade por municipio para heat map
  const severidadePorMunicipio = calcularSeveridadePorMunicipio(interrupcoes);

  if (isLoading) {
    return (
      <div className="h-[600px] flex items-center justify-center bg-gray-100 rounded-lg">
        <div className="text-center">
          <div className="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-2" />
          <p>Carregando mapa...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="h-[600px] flex items-center justify-center bg-red-50 rounded-lg">
        <p className="text-red-600">Erro ao carregar dados do mapa</p>
      </div>
    );
  }

  return (
    <div className="relative">
      <MapContainer
        center={CENTRO_RORAIMA}
        zoom={ZOOM_INICIAL}
        className="h-[600px] rounded-lg shadow-lg"
      >
        {/* Tiles do OpenStreetMap */}
        <TileLayer
          attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
          url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
        />

        {/* GeoJSON dos municipios */}
        {geojson && (
          <GeoJSON
            data={geojson}
            style={(feature) =>
              estilizarMunicipio(
                feature?.properties?.codigo_ibge,
                severidadePorMunicipio
              )
            }
            onEachFeature={(feature, layer) => {
              layer.bindTooltip(feature.properties?.nome || 'Municipio');
            }}
          />
        )}

        {/* Marcadores de interrupcoes */}
        {interrupcoes.map((interrupcao) => (
          <Marker
            key={interrupcao.id}
            position={[
              interrupcao.coordenadas.latitude,
              interrupcao.coordenadas.longitude,
            ]}
            icon={criarIcone(interrupcao.corFaixa)}
            eventHandlers={{
              click: () => onInterrupcaoClick?.(interrupcao),
            }}
          >
            <Popup>
              <PopupContent interrupcao={interrupcao} />
            </Popup>
          </Marker>
        ))}

        {/* Controle de zoom para limites de RR */}
        <FitBoundsControl />
      </MapContainer>

      {/* Legenda */}
      <Legenda />

      {/* Indicador de cache */}
      {response?.fromCache && (
        <div className="absolute top-2 right-2 bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs">
          Dados em cache
        </div>
      )}
    </div>
  );
}

// Componente do popup
function PopupContent({ interrupcao }: { interrupcao: InterrupcaoMapa }) {
  return (
    <div className="min-w-[250px]">
      <h3 className="font-bold text-lg border-b pb-1 mb-2">
        Ocorrencia #{interrupcao.numeroOcorrencia}
      </h3>

      <div className="space-y-1 text-sm">
        <p>
          <strong>Local:</strong> {interrupcao.bairro}, {interrupcao.nomeMunicipio}
        </p>
        <p>
          <strong>Inicio:</strong>{' '}
          {new Date(interrupcao.dataInicio).toLocaleString('pt-BR')}
        </p>
        <p>
          <strong>Status:</strong>{' '}
          <span
            style={{ color: interrupcao.statusCor }}
            className="font-semibold"
          >
            {interrupcao.statusLabel}
          </span>
        </p>
        <p>
          <strong>Tipo:</strong> {interrupcao.tipo.replace('_', ' ')}
        </p>
        <p>
          <strong>Duracao:</strong>{' '}
          <span style={{ color: interrupcao.corFaixa }} className="font-semibold">
            {interrupcao.faixaDuracaoLabel}
          </span>
        </p>
        <p>
          <strong>UCs Afetadas:</strong>{' '}
          {interrupcao.ucsAfetadas.toLocaleString('pt-BR')}
        </p>
        <p>
          <strong>CHI:</strong> {interrupcao.chi.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
          })}
        </p>
        <p>
          <strong>Equipes:</strong> {interrupcao.equipesDesignadas}
        </p>
        <p>
          <strong>Causa:</strong>{' '}
          {interrupcao.causaConhecida
            ? interrupcao.causa
            : 'Em investigacao'}
        </p>
        {interrupcao.previsaoRestabelecimento && (
          <p>
            <strong>Previsao:</strong>{' '}
            {new Date(interrupcao.previsaoRestabelecimento).toLocaleString(
              'pt-BR'
            )}
          </p>
        )}
      </div>
    </div>
  );
}

// Controle para ajustar bounds
function FitBoundsControl() {
  const map = useMap();

  useEffect(() => {
    // Limites aproximados de Roraima
    const bounds = L.latLngBounds(
      [-1.6, -64.9], // Sudoeste
      [5.4, -58.8] // Nordeste
    );
    map.fitBounds(bounds);
  }, [map]);

  return null;
}

// Calcular severidade por municipio
function calcularSeveridadePorMunicipio(
  interrupcoes: InterrupcaoMapa[]
): Record<string, number> {
  const severidade: Record<string, number> = {};

  for (const i of interrupcoes) {
    const ibge = i.codigoIbge;
    const peso = PESO_FAIXA[i.faixaDuracao] || 1;

    severidade[ibge] = (severidade[ibge] || 0) + peso * i.ucsAfetadas;
  }

  return severidade;
}

const PESO_FAIXA: Record<FaixaDuracao, number> = {
  ATE_1H: 1,
  DE_1_A_3H: 2,
  DE_3_A_6H: 3,
  DE_6_A_12H: 4,
  DE_12_A_24H: 5,
  DE_24_A_48H: 6,
  MAIS_48H: 7,
};

// Estilizar municipio baseado na severidade
function estilizarMunicipio(
  codigoIbge: string | undefined,
  severidade: Record<string, number>
) {
  const sev = codigoIbge ? severidade[codigoIbge] || 0 : 0;

  // Calcular cor baseada na severidade
  const maxSev = Math.max(...Object.values(severidade), 1);
  const ratio = sev / maxSev;

  // Interpolar de verde (sem problemas) para vermelho (critico)
  const cor =
    sev === 0
      ? '#e8f5e9' // Verde muito claro
      : `rgba(244, 67, 54, ${0.2 + ratio * 0.6})`; // Vermelho com opacidade

  return {
    fillColor: cor,
    fillOpacity: 0.6,
    color: '#333',
    weight: 1,
  };
}
```

### Legenda.tsx

```typescript
// src/components/MapaRoraima/Legenda.tsx
import { CORES_FAIXA } from './constants';

const FAIXAS = [
  { faixa: 'ATE_1H', label: 'Menos de 1 hora' },
  { faixa: 'DE_1_A_3H', label: '1 a 3 horas' },
  { faixa: 'DE_3_A_6H', label: '3 a 6 horas' },
  { faixa: 'DE_6_A_12H', label: '6 a 12 horas' },
  { faixa: 'DE_12_A_24H', label: '12 a 24 horas' },
  { faixa: 'DE_24_A_48H', label: '24 a 48 horas' },
  { faixa: 'MAIS_48H', label: 'Mais de 48 horas' },
];

export function Legenda() {
  return (
    <div className="absolute bottom-4 left-4 bg-white p-3 rounded-lg shadow-lg z-[1000]">
      <h4 className="font-bold text-sm mb-2">Faixa de Duracao</h4>
      <div className="space-y-1">
        {FAIXAS.map(({ faixa, label }) => (
          <div key={faixa} className="flex items-center gap-2 text-xs">
            <div
              className="w-4 h-4 rounded-full border border-gray-300"
              style={{ backgroundColor: CORES_FAIXA[faixa] }}
            />
            <span>{label}</span>
          </div>
        ))}
      </div>
    </div>
  );
}
```

## Testes

```typescript
// src/components/MapaRoraima/MapaRoraima.test.tsx
import { render, screen, waitFor } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { describe, it, expect, vi } from 'vitest';
import { MapaRoraima } from './MapaRoraima';

// Mock do servico
vi.mock('@/services/api', () => ({
  mapaService: {
    getInterrupcoes: vi.fn().mockResolvedValue({
      success: true,
      data: [],
      fromCache: false,
    }),
    getMunicipiosGeojson: vi.fn().mockResolvedValue({
      type: 'FeatureCollection',
      features: [],
    }),
  },
}));

const queryClient = new QueryClient({
  defaultOptions: {
    queries: { retry: false },
  },
});

const wrapper = ({ children }) => (
  <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
);

describe('MapaRoraima', () => {
  it('deve renderizar loading inicialmente', () => {
    render(<MapaRoraima />, { wrapper });

    expect(screen.getByText(/carregando/i)).toBeInTheDocument();
  });

  it('deve renderizar mapa apos carregar', async () => {
    render(<MapaRoraima />, { wrapper });

    await waitFor(() => {
      expect(screen.queryByText(/carregando/i)).not.toBeInTheDocument();
    });
  });

  it('deve mostrar legenda', async () => {
    render(<MapaRoraima />, { wrapper });

    await waitFor(() => {
      expect(screen.getByText(/faixa de duracao/i)).toBeInTheDocument();
    });
  });
});
```

## Criterios de Aceite

- [ ] Mapa renderiza com tiles OSM
- [ ] GeoJSON dos municipios carregado
- [ ] Marcadores coloridos por faixa
- [ ] Popup com todas informacoes do Art. 107
- [ ] Heat map por severidade
- [ ] Legenda visivel
- [ ] Responsivo
- [ ] Testes passando

## Comando de Execucao

```bash
# Desenvolvimento
npm run dev

# Testes
npm test src/components/MapaRoraima
```
