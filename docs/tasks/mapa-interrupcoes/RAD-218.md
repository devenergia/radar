# RAD-218: Componente PainelEstatisticas

**Fase:** 5 - Frontend
**Tipo:** React Component
**Prioridade:** Alta
**Status:** PENDENTE
**Dependencias:** RAD-215, RAD-216
**Base Legal:** REN 1.137/2025 - Art. 107

## Objetivo

Criar painel com metricas principais das interrupcoes.

## Localizacao

`frontend/src/components/PainelEstatisticas/PainelEstatisticas.tsx`

## Especificacao

### Metricas a Exibir

| Metrica | Art. 107 | Descricao |
|---------|----------|-----------|
| Total Interrupcoes | - | Quantidade de ocorrencias ativas |
| UCs Afetadas | (g) | Total de unidades consumidoras |
| CHI Total | (h) | Consumidor Hora Interrompido |
| Equipes em Campo | (k) | Total de equipes designadas |
| Por Faixa | (d/j) | Distribuicao por faixa de duracao |

## Implementacao

```typescript
// src/components/PainelEstatisticas/PainelEstatisticas.tsx
import { useQuery } from '@tanstack/react-query';
import { mapaService } from '@/services/api';
import type { EstatisticasMapa, FaixaEstatistica } from '@/types';
import { formatDistanceToNow } from 'date-fns';
import { ptBR } from 'date-fns/locale';

export function PainelEstatisticas() {
  const { data: response, isLoading, error } = useQuery({
    queryKey: ['estatisticas'],
    queryFn: () => mapaService.getEstatisticas(),
  });

  if (isLoading) {
    return <PainelSkeleton />;
  }

  if (error || !response?.data) {
    return (
      <div className="bg-red-50 p-4 rounded-lg">
        <p className="text-red-600">Erro ao carregar estatisticas</p>
      </div>
    );
  }

  const stats = response.data;

  return (
    <div className="bg-white rounded-lg shadow-lg p-4 space-y-4">
      <h2 className="text-xl font-bold border-b pb-2">
        Estatisticas em Tempo Real
      </h2>

      {/* Cards de resumo */}
      <div className="grid grid-cols-2 gap-3">
        <CardMetrica
          titulo="Interrupcoes"
          valor={stats.resumo.totalInterrupcoes}
          icone="âš¡"
          cor="bg-blue-100 text-blue-800"
        />
        <CardMetrica
          titulo="UCs Afetadas"
          valor={stats.resumo.totalUcsAfetadas}
          formato="numero"
          icone="ðŸ "
          cor="bg-orange-100 text-orange-800"
        />
        <CardMetrica
          titulo="CHI Total"
          valor={stats.resumo.chiTotal}
          formato="decimal"
          icone="â±ï¸"
          cor="bg-purple-100 text-purple-800"
        />
        <CardMetrica
          titulo="Equipes em Campo"
          valor={stats.resumo.equipesEmCampo}
          icone="ðŸ‘·"
          cor="bg-green-100 text-green-800"
        />
      </div>

      {/* Grafico por faixa */}
      <div>
        <h3 className="font-semibold mb-2">Por Faixa de Duracao</h3>
        <GraficoPorFaixa faixas={stats.porFaixa} />
      </div>

      {/* Top municipios */}
      <div>
        <h3 className="font-semibold mb-2">Top Municipios Afetados</h3>
        <TopMunicipios municipios={stats.porMunicipio.slice(0, 5)} />
      </div>

      {/* Por tipo */}
      <div className="flex justify-between text-sm">
        <span>
          Programadas:{' '}
          <strong className="text-green-600">{stats.porTipo.programada}</strong>
        </span>
        <span>
          Nao Programadas:{' '}
          <strong className="text-red-600">{stats.porTipo.naoProgramada}</strong>
        </span>
      </div>

      {/* Timestamp */}
      <div className="text-xs text-gray-500 text-right">
        Atualizado{' '}
        {formatDistanceToNow(new Date(stats.ultimaAtualizacao), {
          addSuffix: true,
          locale: ptBR,
        })}
        {response.fromCache && ' (cache)'}
      </div>
    </div>
  );
}

// Card de metrica individual
interface CardMetricaProps {
  titulo: string;
  valor: number;
  formato?: 'numero' | 'decimal';
  icone: string;
  cor: string;
}

function CardMetrica({
  titulo,
  valor,
  formato = 'numero',
  icone,
  cor,
}: CardMetricaProps) {
  const valorFormatado =
    formato === 'decimal'
      ? valor.toLocaleString('pt-BR', { minimumFractionDigits: 1 })
      : valor.toLocaleString('pt-BR');

  return (
    <div className={`${cor} rounded-lg p-3`}>
      <div className="flex items-center gap-2">
        <span className="text-2xl">{icone}</span>
        <div>
          <div className="text-2xl font-bold">{valorFormatado}</div>
          <div className="text-xs opacity-80">{titulo}</div>
        </div>
      </div>
    </div>
  );
}

// Grafico de barras por faixa
function GraficoPorFaixa({ faixas }: { faixas: FaixaEstatistica[] }) {
  const maxQtd = Math.max(...faixas.map((f) => f.quantidade), 1);

  return (
    <div className="space-y-2">
      {faixas.map((faixa) => (
        <div key={faixa.faixa} className="flex items-center gap-2 text-sm">
          <div
            className="w-3 h-3 rounded-full flex-shrink-0"
            style={{ backgroundColor: faixa.cor }}
          />
          <div className="w-24 truncate text-xs">{faixa.label}</div>
          <div className="flex-1 bg-gray-200 rounded-full h-4 overflow-hidden">
            <div
              className="h-full rounded-full transition-all duration-500"
              style={{
                width: `${(faixa.quantidade / maxQtd) * 100}%`,
                backgroundColor: faixa.cor,
              }}
            />
          </div>
          <div className="w-8 text-right font-semibold">{faixa.quantidade}</div>
        </div>
      ))}
    </div>
  );
}

// Lista de top municipios
function TopMunicipios({
  municipios,
}: {
  municipios: Array<{ nome: string; quantidade: number; ucsAfetadas: number }>;
}) {
  if (municipios.length === 0) {
    return <p className="text-gray-500 text-sm">Nenhuma interrupcao ativa</p>;
  }

  return (
    <div className="space-y-1">
      {municipios.map((mun, index) => (
        <div
          key={mun.nome}
          className="flex justify-between text-sm py-1 border-b last:border-0"
        >
          <span>
            {index + 1}. {mun.nome}
          </span>
          <span className="text-gray-600">
            {mun.quantidade} ({mun.ucsAfetadas.toLocaleString('pt-BR')} UCs)
          </span>
        </div>
      ))}
    </div>
  );
}

// Skeleton de loading
function PainelSkeleton() {
  return (
    <div className="bg-white rounded-lg shadow-lg p-4 space-y-4 animate-pulse">
      <div className="h-6 bg-gray-200 rounded w-1/2" />
      <div className="grid grid-cols-2 gap-3">
        {[1, 2, 3, 4].map((i) => (
          <div key={i} className="h-20 bg-gray-200 rounded" />
        ))}
      </div>
      <div className="h-32 bg-gray-200 rounded" />
    </div>
  );
}
```

## Testes

```typescript
// src/components/PainelEstatisticas/PainelEstatisticas.test.tsx
import { render, screen, waitFor } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { describe, it, expect, vi } from 'vitest';
import { PainelEstatisticas } from './PainelEstatisticas';

const mockEstatisticas = {
  success: true,
  data: {
    resumo: {
      totalInterrupcoes: 25,
      totalUcsAfetadas: 5000,
      chiTotal: 15000.0,
      equipesEmCampo: 15,
    },
    porFaixa: [
      {
        faixa: 'ATE_1H',
        label: 'Menos de 1 hora',
        cor: '#4CAF50',
        quantidade: 5,
        percentual: 20,
        ucsAfetadas: 500,
      },
    ],
    porMunicipio: [
      {
        codigoIbge: '1400100',
        nome: 'Boa Vista',
        quantidade: 10,
        percentual: 40,
        ucsAfetadas: 2000,
      },
    ],
    porTipo: {
      programada: 5,
      naoProgramada: 20,
    },
    ultimaAtualizacao: new Date().toISOString(),
  },
  fromCache: false,
};

vi.mock('@/services/api', () => ({
  mapaService: {
    getEstatisticas: vi.fn().mockResolvedValue(mockEstatisticas),
  },
}));

const queryClient = new QueryClient({
  defaultOptions: { queries: { retry: false } },
});

const wrapper = ({ children }) => (
  <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
);

describe('PainelEstatisticas', () => {
  it('deve mostrar total de interrupcoes', async () => {
    render(<PainelEstatisticas />, { wrapper });

    await waitFor(() => {
      expect(screen.getByText('25')).toBeInTheDocument();
    });
  });

  it('deve mostrar UCs afetadas', async () => {
    render(<PainelEstatisticas />, { wrapper });

    await waitFor(() => {
      expect(screen.getByText('5.000')).toBeInTheDocument();
    });
  });

  it('deve mostrar equipes em campo', async () => {
    render(<PainelEstatisticas />, { wrapper });

    await waitFor(() => {
      expect(screen.getByText('15')).toBeInTheDocument();
    });
  });

  it('deve mostrar grafico por faixa', async () => {
    render(<PainelEstatisticas />, { wrapper });

    await waitFor(() => {
      expect(screen.getByText('Menos de 1 hora')).toBeInTheDocument();
    });
  });

  it('deve mostrar top municipios', async () => {
    render(<PainelEstatisticas />, { wrapper });

    await waitFor(() => {
      expect(screen.getByText(/Boa Vista/)).toBeInTheDocument();
    });
  });
});
```

## Criterios de Aceite

- [ ] Cards de metricas principais
- [ ] Grafico de barras por faixa
- [ ] Lista de top municipios
- [ ] Contagem por tipo
- [ ] Timestamp de atualizacao
- [ ] Indicador de cache
- [ ] Loading skeleton
- [ ] Tratamento de erro
- [ ] Responsivo
- [ ] Testes passando

## Comando de Execucao

```bash
# Desenvolvimento
npm run dev

# Testes
npm test src/components/PainelEstatisticas
```
