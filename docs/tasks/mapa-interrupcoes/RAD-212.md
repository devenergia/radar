# RAD-212: Schemas Pydantic (Mapa)

**Fase:** 4 - Interfaces Layer
**Tipo:** API Schemas
**Prioridade:** Alta
**Status:** PENDENTE
**Dependencias:** RAD-203, RAD-200, RAD-201
**Base Legal:** REN 1.137/2025 - Art. 107

## Objetivo

Criar schemas Pydantic para serializar dados do mapa de interrupcoes.

## Localizacao

`backend/apps/mapa_interrupcoes/schemas.py`

## Especificacao

### Principios Aplicados

- **Clean Architecture:** Schemas na camada de interfaces
- **Single Responsibility:** Apenas serialização/validação
- **DRY:** Schemas reutilizaveis

### Schemas Requeridos

| Schema | Uso | Campos |
|--------|-----|--------|
| `InterrupcaoMapaResponse` | Resposta de interrupcao | Todos do Art. 107 |
| `EstatisticasResponse` | Metricas agregadas | Totais e por faixa |
| `MunicipioResponse` | Dados do municipio | IBGE, nome, centroid |
| `FiltrosQuery` | Query params | municipio, faixa |

## Implementacao

```python
# apps/mapa_interrupcoes/schemas.py
"""Schemas Pydantic para API do Mapa de Interrupcoes."""
from datetime import datetime
from pydantic import BaseModel, Field, ConfigDict
from typing import Annotated

from shared.domain.value_objects.faixa_duracao import FaixaDuracao
from shared.domain.value_objects.status_ocorrencia import StatusOcorrencia


# =============================================================================
# Schemas de Coordenadas
# =============================================================================

class CoordenadasSchema(BaseModel):
    """Schema para coordenadas geograficas."""

    latitude: float = Field(
        ...,
        ge=-90,
        le=90,
        description="Latitude em graus decimais",
        examples=[2.823841],
    )
    longitude: float = Field(
        ...,
        ge=-180,
        le=180,
        description="Longitude em graus decimais",
        examples=[-60.675833],
    )

    model_config = ConfigDict(frozen=True)


# =============================================================================
# Schemas de Interrupcao
# =============================================================================

class InterrupcaoMapaResponse(BaseModel):
    """
    Schema para interrupcao no mapa.

    Conforme REN 1.137/2025 Art. 107:
    a) numero da ocorrencia
    b) municipio ou bairro
    c) data e hora
    d) tipo e faixa de duracao
    e) causa (se conhecida)
    f) status
    g) quantidade de UCs afetadas
    h) CHI
    i) previsao de restabelecimento
    k) equipes em campo
    """

    # (a) Numero da ocorrencia
    id: str = Field(..., description="ID unico da interrupcao")
    numero_ocorrencia: str = Field(
        ...,
        alias="numeroOcorrencia",
        description="Numero da ocorrencia",
    )

    # (b) Municipio/Bairro
    codigo_ibge: str = Field(
        ...,
        alias="codigoIbge",
        min_length=7,
        max_length=7,
        description="Codigo IBGE do municipio",
    )
    nome_municipio: str = Field(
        ...,
        alias="nomeMunicipio",
        description="Nome do municipio",
    )
    bairro: str = Field(..., description="Bairro ou localidade")
    coordenadas: CoordenadasSchema = Field(
        ...,
        description="Coordenadas para marcador no mapa",
    )

    # (c) Data e hora
    data_hora: datetime = Field(
        ...,
        alias="dataHora",
        description="Data e hora da ocorrencia",
    )
    data_inicio: datetime = Field(
        ...,
        alias="dataInicio",
        description="Data e hora de inicio",
    )

    # (d) Tipo e faixa de duracao
    tipo: str = Field(
        ...,
        description="PROGRAMADA ou NAO_PROGRAMADA",
    )
    faixa_duracao: str = Field(
        ...,
        alias="faixaDuracao",
        description="Faixa de duracao (ex: DE_1_A_3H)",
    )
    faixa_duracao_label: str = Field(
        ...,
        alias="faixaDuracaoLabel",
        description="Label legivel da faixa",
    )
    cor_faixa: str = Field(
        ...,
        alias="corFaixa",
        description="Cor hexadecimal da faixa",
    )

    # (e) Causa
    causa: str | None = Field(
        None,
        description="Causa da interrupcao (se conhecida)",
    )
    causa_conhecida: bool = Field(
        ...,
        alias="causaConhecida",
        description="Se a causa ja foi identificada",
    )

    # (f) Status
    status: str = Field(
        ...,
        description="Status atual da ocorrencia",
    )
    status_label: str = Field(
        ...,
        alias="statusLabel",
        description="Label legivel do status",
    )
    status_cor: str = Field(
        ...,
        alias="statusCor",
        description="Cor do status",
    )
    status_icone: str = Field(
        ...,
        alias="statusIcone",
        description="Icone do status (Material Icons)",
    )

    # (g) UCs afetadas
    ucs_afetadas: int = Field(
        ...,
        alias="ucsAfetadas",
        ge=0,
        description="Quantidade de UCs afetadas",
    )

    # (h) CHI
    chi: float = Field(
        ...,
        ge=0,
        description="Consumidor Hora Interrompido",
    )

    # (i) Previsao
    previsao_restabelecimento: datetime | None = Field(
        None,
        alias="previsaoRestabelecimento",
        description="Previsao de restabelecimento (se conhecida)",
    )

    # (k) Equipes
    equipes_designadas: int = Field(
        ...,
        alias="equipesDesignadas",
        ge=0,
        description="Quantidade de equipes em campo",
    )

    model_config = ConfigDict(
        populate_by_name=True,
        from_attributes=True,
    )

    @classmethod
    def from_entity(cls, entity) -> "InterrupcaoMapaResponse":
        """Converte Entity para Schema."""
        return cls(
            id=entity.id,
            numero_ocorrencia=entity.numero_ocorrencia,
            codigo_ibge=entity.municipio.valor,
            nome_municipio=cls._get_nome_municipio(entity.municipio.valor),
            bairro=entity.bairro,
            coordenadas=CoordenadasSchema(
                latitude=entity.coordenadas.latitude,
                longitude=entity.coordenadas.longitude,
            ),
            data_hora=entity.data_hora,
            data_inicio=entity.data_inicio,
            tipo=entity.tipo.value,
            faixa_duracao=entity.faixa_duracao.value,
            faixa_duracao_label=entity.faixa_duracao.get_label(),
            cor_faixa=entity.faixa_duracao.get_cor(),
            causa=entity.causa,
            causa_conhecida=entity.causa_conhecida,
            status=entity.status.value,
            status_label=entity.status.get_label(),
            status_cor=entity.status.get_cor(),
            status_icone=entity.status.get_icone(),
            ucs_afetadas=entity.ucs_afetadas,
            chi=entity.chi,
            previsao_restabelecimento=entity.previsao_restabelecimento,
            equipes_designadas=entity.equipes_designadas,
        )

    @staticmethod
    def _get_nome_municipio(codigo: str) -> str:
        """Retorna nome do municipio pelo codigo IBGE."""
        nomes = {
            "1400050": "Alto Alegre",
            "1400027": "Amajari",
            "1400100": "Boa Vista",
            "1400159": "Bonfim",
            "1400175": "Canta",
            "1400209": "Caracarai",
            "1400233": "Caroebe",
            "1400282": "Iracema",
            "1400308": "Mucajai",
            "1400407": "Normandia",
            "1400456": "Pacaraima",
            "1400472": "Rorainopolis",
            "1400506": "Sao Joao da Baliza",
            "1400605": "Sao Luiz",
            "1400704": "Uiramuta",
        }
        return nomes.get(codigo, "Desconhecido")


# =============================================================================
# Schemas de Estatisticas
# =============================================================================

class FaixaEstatisticaSchema(BaseModel):
    """Schema para estatisticas por faixa."""

    faixa: str = Field(..., description="Codigo da faixa")
    label: str = Field(..., description="Label legivel")
    cor: str = Field(..., description="Cor hexadecimal")
    quantidade: int = Field(..., ge=0, description="Quantidade de interrupcoes")
    ucs_afetadas: int = Field(
        ...,
        alias="ucsAfetadas",
        ge=0,
        description="UCs afetadas nesta faixa",
    )

    model_config = ConfigDict(populate_by_name=True)


class MunicipioEstatisticaSchema(BaseModel):
    """Schema para estatisticas por municipio."""

    codigo_ibge: str = Field(..., alias="codigoIbge")
    nome: str
    quantidade: int = Field(..., ge=0)
    ucs_afetadas: int = Field(..., alias="ucsAfetadas", ge=0)

    model_config = ConfigDict(populate_by_name=True)


class EstatisticasResponse(BaseModel):
    """Schema para estatisticas agregadas do mapa."""

    total_interrupcoes: int = Field(
        ...,
        alias="totalInterrupcoes",
        ge=0,
        description="Total de interrupcoes ativas",
    )
    total_ucs_afetadas: int = Field(
        ...,
        alias="totalUcsAfetadas",
        ge=0,
        description="Total de UCs afetadas",
    )
    chi_total: float = Field(
        ...,
        alias="chiTotal",
        ge=0,
        description="CHI total",
    )
    equipes_em_campo: int = Field(
        ...,
        alias="equipesEmCampo",
        ge=0,
        description="Total de equipes em campo",
    )
    por_faixa: list[FaixaEstatisticaSchema] = Field(
        ...,
        alias="porFaixa",
        description="Estatisticas por faixa de duracao",
    )
    por_municipio: list[MunicipioEstatisticaSchema] = Field(
        ...,
        alias="porMunicipio",
        description="Estatisticas por municipio",
    )
    ultima_atualizacao: datetime = Field(
        ...,
        alias="ultimaAtualizacao",
        description="Timestamp da ultima atualizacao",
    )

    model_config = ConfigDict(populate_by_name=True)


# =============================================================================
# Schemas de Response da API
# =============================================================================

class MapaInterrupcoesResponse(BaseModel):
    """Response completa da API de interrupcoes do mapa."""

    success: bool = True
    data: list[InterrupcaoMapaResponse]
    estatisticas: EstatisticasResponse | None = None
    from_cache: bool = Field(
        ...,
        alias="fromCache",
        description="Se os dados vieram do cache",
    )

    model_config = ConfigDict(populate_by_name=True)


class ErrorResponse(BaseModel):
    """Schema para respostas de erro."""

    success: bool = False
    error: str
    code: str | None = None
    details: dict | None = None
```

## Testes TDD (Escrever PRIMEIRO)

```python
# tests/unit/schemas/test_mapa_schemas.py
import pytest
from datetime import datetime
from pydantic import ValidationError

from apps.mapa_interrupcoes.schemas import (
    CoordenadasSchema,
    InterrupcaoMapaResponse,
    EstatisticasResponse,
    FaixaEstatisticaSchema,
)


class TestCoordenadasSchema:
    """Testes para CoordenadasSchema."""

    def test_deve_aceitar_coordenadas_validas(self):
        """Coordenadas validas devem ser aceitas."""
        coords = CoordenadasSchema(latitude=2.823841, longitude=-60.675833)

        assert coords.latitude == 2.823841
        assert coords.longitude == -60.675833

    def test_deve_rejeitar_latitude_invalida(self):
        """Latitude fora de [-90, 90] deve falhar."""
        with pytest.raises(ValidationError):
            CoordenadasSchema(latitude=91.0, longitude=-60.0)

    def test_deve_rejeitar_longitude_invalida(self):
        """Longitude fora de [-180, 180] deve falhar."""
        with pytest.raises(ValidationError):
            CoordenadasSchema(latitude=2.0, longitude=181.0)


class TestInterrupcaoMapaResponse:
    """Testes para InterrupcaoMapaResponse."""

    @pytest.fixture
    def dados_validos(self):
        """Dados validos para criacao."""
        return {
            "id": "INT-001",
            "numeroOcorrencia": "2025-001234",
            "codigoIbge": "1400100",
            "nomeMunicipio": "Boa Vista",
            "bairro": "Centro",
            "coordenadas": {"latitude": 2.823841, "longitude": -60.675833},
            "dataHora": datetime.now(),
            "dataInicio": datetime.now(),
            "tipo": "NAO_PROGRAMADA",
            "faixaDuracao": "DE_1_A_3H",
            "faixaDuracaoLabel": "1 a 3 horas",
            "corFaixa": "#8BC34A",
            "causa": None,
            "causaConhecida": False,
            "status": "EM_EXECUCAO",
            "statusLabel": "Em Execucao",
            "statusCor": "#FF9800",
            "statusIcone": "engineering",
            "ucsAfetadas": 150,
            "chi": 300.0,
            "previsaoRestabelecimento": None,
            "equipesDesignadas": 2,
        }

    def test_deve_criar_com_dados_validos(self, dados_validos):
        """Deve criar schema com dados validos."""
        response = InterrupcaoMapaResponse(**dados_validos)

        assert response.id == "INT-001"
        assert response.ucs_afetadas == 150

    def test_deve_usar_alias_para_camelcase(self, dados_validos):
        """Deve suportar aliases camelCase."""
        response = InterrupcaoMapaResponse(**dados_validos)
        json_dict = response.model_dump(by_alias=True)

        assert "ucsAfetadas" in json_dict
        assert "numeroOcorrencia" in json_dict
        assert "codigoIbge" in json_dict

    def test_deve_rejeitar_ucs_negativas(self, dados_validos):
        """UCs afetadas negativas devem falhar."""
        dados_validos["ucsAfetadas"] = -10

        with pytest.raises(ValidationError):
            InterrupcaoMapaResponse(**dados_validos)

    def test_deve_validar_codigo_ibge_7_digitos(self, dados_validos):
        """Codigo IBGE deve ter 7 digitos."""
        dados_validos["codigoIbge"] = "140010"  # 6 digitos

        with pytest.raises(ValidationError):
            InterrupcaoMapaResponse(**dados_validos)


class TestEstatisticasResponse:
    """Testes para EstatisticasResponse."""

    def test_deve_criar_com_dados_validos(self):
        """Deve criar schema com dados validos."""
        response = EstatisticasResponse(
            totalInterrupcoes=10,
            totalUcsAfetadas=1000,
            chiTotal=5000.0,
            equipesEmCampo=5,
            porFaixa=[],
            porMunicipio=[],
            ultimaAtualizacao=datetime.now(),
        )

        assert response.total_interrupcoes == 10
        assert response.chi_total == 5000.0

    def test_deve_incluir_estatisticas_por_faixa(self):
        """Deve incluir lista de faixas."""
        faixas = [
            FaixaEstatisticaSchema(
                faixa="ATE_1H",
                label="Menos de 1 hora",
                cor="#4CAF50",
                quantidade=5,
                ucsAfetadas=200,
            ),
        ]

        response = EstatisticasResponse(
            totalInterrupcoes=5,
            totalUcsAfetadas=200,
            chiTotal=100.0,
            equipesEmCampo=2,
            porFaixa=faixas,
            porMunicipio=[],
            ultimaAtualizacao=datetime.now(),
        )

        assert len(response.por_faixa) == 1
        assert response.por_faixa[0].faixa == "ATE_1H"
```

## Criterios de Aceite

- [ ] Testes escritos e passando
- [ ] Todos campos do Art. 107 presentes
- [ ] Aliases camelCase funcionais
- [ ] Validacoes Pydantic corretas
- [ ] Metodo from_entity() funcional
- [ ] Documentacao OpenAPI gerada
- [ ] Cobertura >= 90%

## Comando de Execucao

```bash
# Executar testes (RED)
pytest tests/unit/schemas/test_mapa_schemas.py -v

# Com cobertura
pytest tests/unit/schemas/test_mapa_schemas.py --cov=apps/mapa_interrupcoes/schemas --cov-report=term-missing
```
