# RAD-201: Value Object StatusOcorrencia

**Fase:** 1 - Domain Layer
**Tipo:** Domain
**Prioridade:** Alta
**Status:** PENDENTE
**Dependencias:** -
**Base Legal:** REN 1.137/2025 - Art. 107 alinea "f"

## Objetivo

Criar Value Object para status da ocorrencia conforme REN 1.137/2025.

## Localizacao

`backend/shared/domain/value_objects/status_ocorrencia.py`

## Especificacao

### Status de Ocorrencia (REN 1.137 Art. 107)

| Status | Descricao | Cor |
|--------|-----------|-----|
| `EM_PREPARACAO` | Equipe sendo designada | Azul |
| `DESLOCAMENTO` | Equipe a caminho | Amarelo |
| `EM_EXECUCAO` | Trabalho em andamento | Laranja |
| `CONCLUIDA` | Energia restabelecida | Verde |

### Funcionalidades

1. **from_codigo(codigo):** Cria status a partir de codigo do sistema
2. **get_cor():** Retorna cor para visualizacao
3. **is_ativa():** Retorna se a ocorrencia ainda esta ativa
4. **get_icone():** Retorna nome do icone para o mapa

## Implementacao

```python
# shared/domain/value_objects/status_ocorrencia.py
from enum import Enum


class StatusOcorrencia(Enum):
    """Value Object para status de ocorrencia de interrupcao."""

    EM_PREPARACAO = "EM_PREPARACAO"
    DESLOCAMENTO = "DESLOCAMENTO"
    EM_EXECUCAO = "EM_EXECUCAO"
    CONCLUIDA = "CONCLUIDA"

    @classmethod
    def from_codigo(cls, codigo: str | None) -> "StatusOcorrencia":
        """
        Cria status a partir de codigo do sistema legado.

        Args:
            codigo: Codigo do sistema (P, D, E, C ou None)

        Returns:
            StatusOcorrencia correspondente
        """
        mapping = {
            "P": cls.EM_PREPARACAO,
            "D": cls.DESLOCAMENTO,
            "E": cls.EM_EXECUCAO,
            "C": cls.CONCLUIDA,
            None: cls.EM_PREPARACAO,
        }
        return mapping.get(codigo, cls.EM_PREPARACAO)

    def get_cor(self) -> str:
        """
        Retorna cor hexadecimal para visualizacao.

        Returns:
            Cor hexadecimal
        """
        cores = {
            StatusOcorrencia.EM_PREPARACAO: "#2196F3",  # Azul
            StatusOcorrencia.DESLOCAMENTO: "#FFC107",   # Amarelo
            StatusOcorrencia.EM_EXECUCAO: "#FF9800",    # Laranja
            StatusOcorrencia.CONCLUIDA: "#4CAF50",      # Verde
        }
        return cores[self]

    def is_ativa(self) -> bool:
        """
        Verifica se a ocorrencia esta ativa.

        Returns:
            True se nao estiver concluida
        """
        return self != StatusOcorrencia.CONCLUIDA

    def get_icone(self) -> str:
        """
        Retorna nome do icone para o mapa.

        Returns:
            Nome do icone (Material Icons)
        """
        icones = {
            StatusOcorrencia.EM_PREPARACAO: "schedule",
            StatusOcorrencia.DESLOCAMENTO: "directions_car",
            StatusOcorrencia.EM_EXECUCAO: "engineering",
            StatusOcorrencia.CONCLUIDA: "check_circle",
        }
        return icones[self]

    def get_label(self) -> str:
        """Retorna label para exibicao ao usuario."""
        labels = {
            StatusOcorrencia.EM_PREPARACAO: "Em Preparacao",
            StatusOcorrencia.DESLOCAMENTO: "Equipe a Caminho",
            StatusOcorrencia.EM_EXECUCAO: "Em Execucao",
            StatusOcorrencia.CONCLUIDA: "Concluida",
        }
        return labels[self]

    def get_ordem(self) -> int:
        """Retorna ordem para exibicao (prioridade)."""
        ordens = {
            StatusOcorrencia.EM_PREPARACAO: 1,
            StatusOcorrencia.DESLOCAMENTO: 2,
            StatusOcorrencia.EM_EXECUCAO: 3,
            StatusOcorrencia.CONCLUIDA: 4,
        }
        return ordens[self]
```

## Testes TDD (Escrever PRIMEIRO)

```python
# tests/unit/domain/value_objects/test_status_ocorrencia.py
import pytest
from shared.domain.value_objects.status_ocorrencia import StatusOcorrencia


class TestStatusOcorrencia:
    """Testes para Value Object StatusOcorrencia."""

    class TestFromCodigo:
        """Testes para factory from_codigo()."""

        @pytest.mark.parametrize("codigo,esperado", [
            ("P", StatusOcorrencia.EM_PREPARACAO),
            ("D", StatusOcorrencia.DESLOCAMENTO),
            ("E", StatusOcorrencia.EM_EXECUCAO),
            ("C", StatusOcorrencia.CONCLUIDA),
            (None, StatusOcorrencia.EM_PREPARACAO),
        ])
        def test_deve_mapear_codigo_para_status(self, codigo, esperado):
            """Testa mapeamento de codigos para status."""
            assert StatusOcorrencia.from_codigo(codigo) == esperado

        def test_codigo_desconhecido_retorna_em_preparacao(self):
            """Codigo desconhecido deve retornar EM_PREPARACAO."""
            assert StatusOcorrencia.from_codigo("X") == StatusOcorrencia.EM_PREPARACAO

    class TestIsAtiva:
        """Testes para metodo is_ativa()."""

        @pytest.mark.parametrize("status,esperado", [
            (StatusOcorrencia.EM_PREPARACAO, True),
            (StatusOcorrencia.DESLOCAMENTO, True),
            (StatusOcorrencia.EM_EXECUCAO, True),
            (StatusOcorrencia.CONCLUIDA, False),
        ])
        def test_deve_identificar_ocorrencias_ativas(self, status, esperado):
            """Apenas CONCLUIDA nao e ativa."""
            assert status.is_ativa() == esperado

    class TestGetCor:
        """Testes para metodo get_cor()."""

        def test_todas_status_devem_ter_cor(self):
            """Todas os status devem ter cor definida."""
            for status in StatusOcorrencia:
                cor = status.get_cor()
                assert cor.startswith("#")
                assert len(cor) == 7

        def test_concluida_deve_ser_verde(self):
            """Status CONCLUIDA deve ter cor verde."""
            assert StatusOcorrencia.CONCLUIDA.get_cor() == "#4CAF50"

    class TestGetIcone:
        """Testes para metodo get_icone()."""

        def test_todas_status_devem_ter_icone(self):
            """Todas os status devem ter icone definido."""
            for status in StatusOcorrencia:
                assert len(status.get_icone()) > 0

        def test_em_execucao_deve_ter_icone_engineering(self):
            """Status EM_EXECUCAO deve ter icone de engenharia."""
            assert StatusOcorrencia.EM_EXECUCAO.get_icone() == "engineering"

    class TestGetLabel:
        """Testes para metodo get_label()."""

        def test_todas_status_devem_ter_label(self):
            """Todas os status devem ter label."""
            for status in StatusOcorrencia:
                assert len(status.get_label()) > 0

    class TestGetOrdem:
        """Testes para metodo get_ordem()."""

        def test_ordem_deve_ser_sequencial(self):
            """Ordem deve seguir fluxo logico."""
            assert StatusOcorrencia.EM_PREPARACAO.get_ordem() == 1
            assert StatusOcorrencia.DESLOCAMENTO.get_ordem() == 2
            assert StatusOcorrencia.EM_EXECUCAO.get_ordem() == 3
            assert StatusOcorrencia.CONCLUIDA.get_ordem() == 4
```

## Criterios de Aceite

- [ ] Testes escritos e passando
- [ ] Enum com 4 status conforme REN 1.137
- [ ] Factory from_codigo() funcional
- [ ] Cores para visualizacao no mapa
- [ ] Icones para marcadores
- [ ] Labels para exibicao
- [ ] Metodo is_ativa() funcional
- [ ] Cobertura >= 90%

## Comando de Execucao

```bash
# Executar testes (RED)
pytest tests/unit/domain/value_objects/test_status_ocorrencia.py -v

# Com cobertura
pytest tests/unit/domain/value_objects/test_status_ocorrencia.py --cov=shared/domain/value_objects/status_ocorrencia --cov-report=term-missing
```
