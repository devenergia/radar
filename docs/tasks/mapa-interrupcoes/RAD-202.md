# RAD-202: Value Object Coordenadas

**Fase:** 1 - Domain Layer
**Tipo:** Domain
**Prioridade:** Alta
**Status:** PENDENTE
**Dependencias:** -
**Base Legal:** REN 1.137/2025 - Art. 106

## Objetivo

Criar Value Object para coordenadas geograficas (Latitude/Longitude) com validacao de Roraima.

## Localizacao

`backend/shared/domain/value_objects/coordenadas.py`

## Especificacao

### Limites Geograficos de Roraima

| Limite | Valor |
|--------|-------|
| Latitude Norte | 5.316667 |
| Latitude Sul | -1.583333 |
| Longitude Oeste | -64.833333 |
| Longitude Leste | -58.850000 |

### Validacoes

1. Latitude: -90 a +90
2. Longitude: -180 a +180
3. Opcionalmente dentro de Roraima (parametro)

### Funcionalidades

1. **create(lat, lng):** Factory com validacao
2. **is_in_roraima():** Verifica se esta em Roraima
3. **distance_to(other):** Calcula distancia em km
4. **to_geojson():** Retorna formato GeoJSON

## Implementacao

```python
# shared/domain/value_objects/coordenadas.py
from dataclasses import dataclass
from math import radians, sin, cos, sqrt, atan2
from ..result import Result


@dataclass(frozen=True)
class Coordenadas:
    """Value Object para coordenadas geograficas."""

    latitude: float
    longitude: float

    # Limites aproximados de Roraima
    RR_LAT_NORTE = 5.316667
    RR_LAT_SUL = -1.583333
    RR_LNG_OESTE = -64.833333
    RR_LNG_LESTE = -58.850000

    # Raio da Terra em km
    RAIO_TERRA_KM = 6371.0

    def __post_init__(self) -> None:
        """Validacao no momento da criacao."""
        if not self._is_valid_latitude():
            raise ValueError(f"Latitude invalida: {self.latitude}")
        if not self._is_valid_longitude():
            raise ValueError(f"Longitude invalida: {self.longitude}")

    def _is_valid_latitude(self) -> bool:
        """Verifica se latitude esta entre -90 e +90."""
        return -90 <= self.latitude <= 90

    def _is_valid_longitude(self) -> bool:
        """Verifica se longitude esta entre -180 e +180."""
        return -180 <= self.longitude <= 180

    def is_in_roraima(self) -> bool:
        """
        Verifica se coordenadas estao dentro de Roraima.

        Returns:
            True se esta dentro dos limites de RR
        """
        return (
            self.RR_LAT_SUL <= self.latitude <= self.RR_LAT_NORTE
            and self.RR_LNG_OESTE <= self.longitude <= self.RR_LNG_LESTE
        )

    @classmethod
    def create(
        cls,
        latitude: float,
        longitude: float,
        validate_roraima: bool = False,
    ) -> "Result[Coordenadas]":
        """
        Factory method com validacao.

        Args:
            latitude: Latitude em graus decimais
            longitude: Longitude em graus decimais
            validate_roraima: Se True, valida se esta em Roraima

        Returns:
            Result com Coordenadas ou erro
        """
        try:
            coords = cls(latitude=latitude, longitude=longitude)
            if validate_roraima and not coords.is_in_roraima():
                return Result.fail(
                    f"Coordenadas fora de Roraima: ({latitude}, {longitude})"
                )
            return Result.ok(coords)
        except ValueError as e:
            return Result.fail(str(e))

    def distance_to(self, other: "Coordenadas") -> float:
        """
        Calcula distancia em km usando formula de Haversine.

        Args:
            other: Outras coordenadas

        Returns:
            Distancia em quilometros
        """
        lat1, lon1 = radians(self.latitude), radians(self.longitude)
        lat2, lon2 = radians(other.latitude), radians(other.longitude)

        dlat = lat2 - lat1
        dlon = lon2 - lon1

        a = sin(dlat / 2) ** 2 + cos(lat1) * cos(lat2) * sin(dlon / 2) ** 2
        c = 2 * atan2(sqrt(a), sqrt(1 - a))

        return self.RAIO_TERRA_KM * c

    def to_geojson(self) -> dict:
        """
        Retorna coordenadas em formato GeoJSON.

        Returns:
            Dict no formato GeoJSON Point
        """
        return {
            "type": "Point",
            "coordinates": [self.longitude, self.latitude],
        }

    def to_tuple(self) -> tuple[float, float]:
        """Retorna como tupla (lat, lng)."""
        return (self.latitude, self.longitude)

    def __str__(self) -> str:
        return f"({self.latitude:.6f}, {self.longitude:.6f})"


# Coordenadas de referencia de Roraima
class CoordenadasRoraima:
    """Coordenadas de referencia dos municipios de Roraima."""

    BOA_VISTA = Coordenadas(2.823841, -60.675833)
    ALTO_ALEGRE = Coordenadas(2.990833, -61.307222)
    AMAJARI = Coordenadas(3.643889, -61.371944)
    BONFIM = Coordenadas(3.362500, -59.830278)
    CANTA = Coordenadas(2.610000, -60.586111)
    CARACARAI = Coordenadas(1.816944, -61.127778)
    CAROEBE = Coordenadas(0.883889, -59.695556)
    IRACEMA = Coordenadas(2.182500, -61.041944)
    MUCAJAI = Coordenadas(2.439722, -60.909722)
    NORMANDIA = Coordenadas(3.880278, -59.622778)
    PACARAIMA = Coordenadas(4.480000, -61.147778)
    RORAINOPOLIS = Coordenadas(0.939167, -60.439722)
    SAO_JOAO_BALIZA = Coordenadas(0.950833, -59.908333)
    SAO_LUIZ = Coordenadas(1.010833, -60.035556)
    UIRAMUTA = Coordenadas(4.596944, -60.182778)
```

## Testes TDD (Escrever PRIMEIRO)

```python
# tests/unit/domain/value_objects/test_coordenadas.py
import pytest
from shared.domain.value_objects.coordenadas import Coordenadas, CoordenadasRoraima


class TestCoordenadas:
    """Testes para Value Object Coordenadas."""

    class TestCreate:
        """Testes para factory create()."""

        def test_deve_criar_coordenadas_validas(self):
            """Coordenadas validas devem ser aceitas."""
            result = Coordenadas.create(2.823841, -60.675833)

            assert result.is_success
            assert result.value.latitude == 2.823841
            assert result.value.longitude == -60.675833

        def test_deve_rejeitar_latitude_invalida(self):
            """Latitude fora de [-90, 90] deve ser rejeitada."""
            result = Coordenadas.create(91.0, -60.0)

            assert result.is_failure
            assert "Latitude" in result.error

        def test_deve_rejeitar_longitude_invalida(self):
            """Longitude fora de [-180, 180] deve ser rejeitada."""
            result = Coordenadas.create(2.0, 181.0)

            assert result.is_failure
            assert "Longitude" in result.error

        def test_deve_validar_roraima_quando_solicitado(self):
            """Com validate_roraima=True, deve verificar limites."""
            # Sao Paulo - fora de Roraima
            result = Coordenadas.create(
                -23.550520, -46.633308,
                validate_roraima=True,
            )

            assert result.is_failure
            assert "Roraima" in result.error

        def test_deve_aceitar_roraima_quando_dentro_limites(self):
            """Coordenadas de Boa Vista devem passar validacao."""
            result = Coordenadas.create(
                2.823841, -60.675833,
                validate_roraima=True,
            )

            assert result.is_success

    class TestIsInRoraima:
        """Testes para metodo is_in_roraima()."""

        def test_boa_vista_esta_em_roraima(self):
            """Coordenadas de Boa Vista estao em RR."""
            coords = Coordenadas.create(2.823841, -60.675833).value

            assert coords.is_in_roraima() is True

        def test_sao_paulo_nao_esta_em_roraima(self):
            """Coordenadas de Sao Paulo nao estao em RR."""
            coords = Coordenadas.create(-23.550520, -46.633308).value

            assert coords.is_in_roraima() is False

        def test_limite_norte_roraima(self):
            """Coordenadas no limite norte de RR."""
            coords = Coordenadas.create(5.0, -60.0).value

            assert coords.is_in_roraima() is True

    class TestDistanceTo:
        """Testes para metodo distance_to()."""

        def test_mesmas_coordenadas_distancia_zero(self):
            """Distancia para mesma coordenada e zero."""
            coords = Coordenadas.create(2.823841, -60.675833).value

            assert coords.distance_to(coords) == 0.0

        def test_distancia_boa_vista_caracarai(self):
            """Distancia Boa Vista - Caracarai ~135 km."""
            bv = CoordenadasRoraima.BOA_VISTA
            cc = CoordenadasRoraima.CARACARAI

            distancia = bv.distance_to(cc)

            # Aproximadamente 135 km
            assert 130 < distancia < 140

    class TestToGeojson:
        """Testes para metodo to_geojson()."""

        def test_formato_geojson_correto(self):
            """Deve retornar formato GeoJSON Point."""
            coords = Coordenadas.create(2.823841, -60.675833).value

            geojson = coords.to_geojson()

            assert geojson["type"] == "Point"
            # GeoJSON usa [lng, lat]
            assert geojson["coordinates"] == [-60.675833, 2.823841]

    class TestEquality:
        """Testes para igualdade de Value Objects."""

        def test_coordenadas_iguais_sao_iguais(self):
            """Coordenadas com mesmos valores sao iguais."""
            c1 = Coordenadas.create(2.823841, -60.675833).value
            c2 = Coordenadas.create(2.823841, -60.675833).value

            assert c1 == c2

        def test_coordenadas_diferentes_sao_diferentes(self):
            """Coordenadas com valores diferentes nao sao iguais."""
            c1 = Coordenadas.create(2.823841, -60.675833).value
            c2 = Coordenadas.create(1.816944, -61.127778).value

            assert c1 != c2


class TestCoordenadasRoraima:
    """Testes para coordenadas de referencia."""

    def test_todas_coordenadas_em_roraima(self):
        """Todas as coordenadas de referencia devem estar em RR."""
        municipios = [
            CoordenadasRoraima.BOA_VISTA,
            CoordenadasRoraima.ALTO_ALEGRE,
            CoordenadasRoraima.AMAJARI,
            CoordenadasRoraima.BONFIM,
            CoordenadasRoraima.CANTA,
            CoordenadasRoraima.CARACARAI,
            CoordenadasRoraima.CAROEBE,
            CoordenadasRoraima.IRACEMA,
            CoordenadasRoraima.MUCAJAI,
            CoordenadasRoraima.NORMANDIA,
            CoordenadasRoraima.PACARAIMA,
            CoordenadasRoraima.RORAINOPOLIS,
            CoordenadasRoraima.SAO_JOAO_BALIZA,
            CoordenadasRoraima.SAO_LUIZ,
            CoordenadasRoraima.UIRAMUTA,
        ]

        for coord in municipios:
            assert coord.is_in_roraima(), f"Falhou para {coord}"
```

## Criterios de Aceite

- [ ] Testes escritos e passando
- [ ] Dataclass frozen (imutavel)
- [ ] Validacao de latitude/longitude
- [ ] Validacao opcional de Roraima
- [ ] Calculo de distancia (Haversine)
- [ ] Conversao para GeoJSON
- [ ] Coordenadas de referencia dos 15 municipios
- [ ] Cobertura >= 90%

## Comando de Execucao

```bash
# Executar testes (RED)
pytest tests/unit/domain/value_objects/test_coordenadas.py -v

# Com cobertura
pytest tests/unit/domain/value_objects/test_coordenadas.py --cov=shared/domain/value_objects/coordenadas --cov-report=term-missing
```
