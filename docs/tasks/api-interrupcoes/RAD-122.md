# RAD-122: API Key Authentication

**Fase:** 6 - Seguranca e Compliance
**Tipo:** Security
**Prioridade:** Alta
**Status:** Existente (necessita validacao)
**Dependencias:** RAD-116

## Objetivo

Implementar autenticacao via API Key conforme especificacao ANEEL.

## Localizacao

`backend/apps/api_interrupcoes/auth/`

## Especificacao

### Requisitos ANEEL

1. **Header obrigatorio:** `x-api-key`
2. **Resposta sem API Key:** HTTP 401
3. **Resposta com API Key invalida:** HTTP 401
4. **Formato da resposta de erro:** Padrao ANEEL

### Fluxo de Autenticacao

```
Request
   │
   ▼
┌──────────────────┐
│ Header x-api-key │
│    presente?     │
└────────┬─────────┘
         │
    ┌────┴────┐
    │         │
   Nao       Sim
    │         │
    ▼         ▼
┌────────┐ ┌──────────────┐
│ 401    │ │ API Key      │
│ Erro   │ │ valida?      │
└────────┘ └──────┬───────┘
                  │
             ┌────┴────┐
             │         │
            Nao       Sim
             │         │
             ▼         ▼
         ┌────────┐ ┌────────┐
         │ 401    │ │ 200    │
         │ Erro   │ │ OK     │
         └────────┘ └────────┘
```

## Implementacao

```python
# apps/api_interrupcoes/auth/api_key.py
from typing import Annotated
from fastapi import Header, HTTPException, status, Depends
from fastapi.security import APIKeyHeader

from shared.infrastructure.config import Settings, get_settings


# Security scheme para OpenAPI
api_key_header = APIKeyHeader(
    name="x-api-key",
    auto_error=False,
    description="API Key para autenticacao",
)


class ApiKeyValidator:
    """
    Validador de API Key.

    Suporta multiplas API Keys e logging de uso.
    """

    def __init__(self, settings: Settings) -> None:
        self._valid_keys = self._load_valid_keys(settings)

    def _load_valid_keys(self, settings: Settings) -> set[str]:
        """Carrega chaves validas das configuracoes."""
        keys = {settings.api_key}

        # Suporte a multiplas chaves (separadas por virgula)
        if settings.api_keys_additional:
            keys.update(settings.api_keys_additional.split(","))

        return keys

    def is_valid(self, api_key: str) -> bool:
        """Verifica se a API Key e valida."""
        return api_key in self._valid_keys


async def verify_api_key(
    api_key: Annotated[str | None, Depends(api_key_header)],
    settings: Settings = Depends(get_settings),
) -> str:
    """
    Dependency para validar API Key.

    Args:
        api_key: Valor do header x-api-key
        settings: Configuracoes da aplicacao

    Returns:
        API Key validada

    Raises:
        HTTPException: 401 se ausente ou invalida
    """
    # Resposta de erro no formato ANEEL
    def error_response(message: str, description: str) -> dict:
        return {
            "idcStatusRequisicao": 2,
            "desStatusRequisicao": description,
            "emailIndisponibilidade": "radar@roraimaenergia.com.br",
            "mensagem": message,
            "interrupcaoFornecimento": [],
        }

    # Verificar presenca
    if api_key is None:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail=error_response(
                "Header x-api-key nao fornecido",
                "Autenticacao necessaria",
            ),
            headers={"WWW-Authenticate": "ApiKey"},
        )

    # Verificar validade
    validator = ApiKeyValidator(settings)
    if not validator.is_valid(api_key):
        # Log tentativa invalida (sem expor a chave)
        import structlog
        logger = structlog.get_logger()
        logger.warning(
            "api_key_invalid",
            key_prefix=api_key[:8] + "..." if len(api_key) > 8 else "***",
        )

        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail=error_response(
                "API Key invalida ou expirada",
                "Autenticacao falhou",
            ),
            headers={"WWW-Authenticate": "ApiKey"},
        )

    return api_key


# Dependency alternativa que nao lanca exception (para rotas opcionais)
async def get_api_key_optional(
    api_key: Annotated[str | None, Depends(api_key_header)],
) -> str | None:
    """
    Dependency opcional para API Key.

    Retorna None se nao fornecida, nao lanca exception.
    """
    return api_key
```

## Configuracao

```python
# shared/infrastructure/config.py
class Settings(BaseSettings):
    # API Key principal
    api_key: str = Field(..., description="API Key principal")

    # API Keys adicionais (separadas por virgula)
    api_keys_additional: str | None = Field(
        None,
        description="API Keys adicionais (separadas por virgula)",
    )

    class Config:
        env_file = ".env"
        env_prefix = "RADAR_"
```

```bash
# .env
RADAR_API_KEY=sua-api-key-principal
RADAR_API_KEYS_ADDITIONAL=key2,key3,key4
```

## OpenAPI/Swagger

```python
# apps/api_interrupcoes/main.py
from fastapi import FastAPI
from fastapi.openapi.utils import get_openapi


def custom_openapi(app: FastAPI):
    """Customiza schema OpenAPI com seguranca."""
    if app.openapi_schema:
        return app.openapi_schema

    openapi_schema = get_openapi(
        title="API Interrupcoes - RADAR",
        version="1.0.0",
        description="API de Quantitativo de Interrupcoes Ativas",
        routes=app.routes,
    )

    # Adicionar security scheme
    openapi_schema["components"]["securitySchemes"] = {
        "ApiKeyAuth": {
            "type": "apiKey",
            "in": "header",
            "name": "x-api-key",
            "description": "API Key para autenticacao",
        }
    }

    # Aplicar security globalmente
    openapi_schema["security"] = [{"ApiKeyAuth": []}]

    app.openapi_schema = openapi_schema
    return app.openapi_schema
```

## Testes

```python
# tests/unit/auth/test_api_key.py
import pytest
from fastapi import HTTPException

from apps.api_interrupcoes.auth.api_key import verify_api_key, ApiKeyValidator
from shared.infrastructure.config import Settings


class TestApiKeyValidator:
    def test_deve_aceitar_api_key_valida(self):
        settings = Settings(api_key="valid-key")
        validator = ApiKeyValidator(settings)

        assert validator.is_valid("valid-key") is True

    def test_deve_rejeitar_api_key_invalida(self):
        settings = Settings(api_key="valid-key")
        validator = ApiKeyValidator(settings)

        assert validator.is_valid("invalid-key") is False

    def test_deve_aceitar_api_keys_adicionais(self):
        settings = Settings(
            api_key="main-key",
            api_keys_additional="extra1,extra2",
        )
        validator = ApiKeyValidator(settings)

        assert validator.is_valid("main-key") is True
        assert validator.is_valid("extra1") is True
        assert validator.is_valid("extra2") is True


class TestVerifyApiKey:
    async def test_deve_retornar_api_key_quando_valida(self):
        settings = Settings(api_key="valid-key")

        result = await verify_api_key("valid-key", settings)

        assert result == "valid-key"

    async def test_deve_lancar_401_quando_ausente(self):
        settings = Settings(api_key="valid-key")

        with pytest.raises(HTTPException) as exc_info:
            await verify_api_key(None, settings)

        assert exc_info.value.status_code == 401

    async def test_deve_lancar_401_quando_invalida(self):
        settings = Settings(api_key="valid-key")

        with pytest.raises(HTTPException) as exc_info:
            await verify_api_key("invalid-key", settings)

        assert exc_info.value.status_code == 401

    async def test_resposta_erro_deve_ter_formato_aneel(self):
        settings = Settings(api_key="valid-key")

        with pytest.raises(HTTPException) as exc_info:
            await verify_api_key("invalid-key", settings)

        detail = exc_info.value.detail
        assert "idcStatusRequisicao" in detail
        assert detail["idcStatusRequisicao"] == 2
        assert "emailIndisponibilidade" in detail
```

## Criterios de Aceite

- [ ] Header x-api-key validado
- [ ] Resposta 401 sem API Key
- [ ] Resposta 401 com API Key invalida
- [ ] Formato de erro ANEEL
- [ ] Suporte a multiplas API Keys
- [ ] Log de tentativas invalidas
- [ ] OpenAPI com security scheme
- [ ] Testes unitarios

## Agentes Recomendados

- `@security-checker` - Para validar implementacao de seguranca
