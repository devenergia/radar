# RAD-100: Value Object CodigoIBGE

**Fase:** 1 - Domain Layer
**Tipo:** Domain
**Prioridade:** Alta
**Status:** Existente
**Dependencias:** -

## Objetivo

Criar Value Object imutavel para codigo IBGE de municipio, com validacao de pertencer a Roraima.

## Localizacao

`backend/shared/domain/value_objects/codigo_ibge.py`

## Especificacao

### Regras de Validacao

1. Codigo deve ter exatamente 7 digitos (1000000 <= codigo <= 9999999)
2. Codigo deve ser um **inteiro** (conforme especificacao ANEEL: `ideMunicipio: int`)
3. Codigo deve pertencer a Roraima (prefixo 14)
4. Codigo deve estar na lista de municipios validos

> **ANEEL Spec:** O campo `ideMunicipio` deve ser inteiro de 7 digitos conforme
> Oficio Circular 14/2025-SFE/ANEEL.

### Municipios de Roraima (15)

| Codigo IBGE | Municipio |
|-------------|-----------|
| 1400050 | Alto Alegre |
| 1400027 | Amajari |
| 1400100 | Boa Vista |
| 1400159 | Bonfim |
| 1400175 | Canta |
| 1400209 | Caracarai |
| 1400233 | Caroebe |
| 1400282 | Iracema |
| 1400308 | Mucajai |
| 1400407 | Normandia |
| 1400456 | Pacaraima |
| 1400472 | Rorainopolis |
| 1400506 | Sao Joao da Baliza |
| 1400605 | Sao Luiz |
| 1400704 | Uiramuta |

## Implementacao

```python
# shared/domain/value_objects/codigo_ibge.py
from __future__ import annotations

from dataclasses import dataclass
from typing import ClassVar

from backend.shared.domain.result import Result


@dataclass(frozen=True, slots=True)
class CodigoIBGE:
    """
    Value Object para Codigo IBGE de Municipio.

    Imutavel e validado na criacao.

    Regras:
    - Deve ter 7 digitos
    - Deve pertencer a Roraima (14xxxxx)
    """

    valor: int  # ANEEL especifica int, nao str

    # Lista de codigos IBGE dos 15 municipios de Roraima
    MUNICIPIOS_RORAIMA: ClassVar[tuple[int, ...]] = (
        1400050,  # Alto Alegre
        1400027,  # Amajari
        1400100,  # Boa Vista
        1400159,  # Bonfim
        1400175,  # Canta
        1400209,  # Caracarai
        1400233,  # Caroebe
        1400282,  # Iracema
        1400308,  # Mucajai
        1400407,  # Normandia
        1400456,  # Pacaraima
        1400472,  # Rorainopolis
        1400506,  # Sao Joao da Baliza
        1400605,  # Sao Luiz
        1400704,  # Uiramuta
    )

    MIN_VALUE: ClassVar[int] = 1000000
    MAX_VALUE: ClassVar[int] = 9999999

    @classmethod
    def create(cls, codigo: int) -> Result[CodigoIBGE]:
        """
        Factory method para criar CodigoIBGE validado.

        Args:
            codigo: Codigo IBGE do municipio (7 digitos, inteiro)

        Returns:
            Result com CodigoIBGE valido ou mensagem de erro
        """
        if not cls._has_seven_digits(codigo):
            return Result.fail(
                f"Codigo IBGE invalido: {codigo}. Deve ter 7 digitos."
            )

        if not cls._belongs_to_roraima(codigo):
            return Result.fail(
                f"Codigo IBGE {codigo} nao pertence a Roraima. "
                f"Codigos validos: {', '.join(map(str, cls.MUNICIPIOS_RORAIMA))}"
            )

        return Result.ok(cls(valor=codigo))

    @classmethod
    def create_unsafe(cls, codigo: int) -> CodigoIBGE:
        """
        Cria CodigoIBGE sem validacao.

        Use apenas quando os dados ja foram validados (ex: vindos do banco).

        Args:
            codigo: Codigo IBGE do municipio

        Returns:
            CodigoIBGE
        """
        return cls(valor=codigo)

    @classmethod
    def _has_seven_digits(cls, codigo: int) -> bool:
        """Verifica se o codigo tem 7 digitos."""
        return cls.MIN_VALUE <= codigo <= cls.MAX_VALUE

    @classmethod
    def _belongs_to_roraima(cls, codigo: int) -> bool:
        """Verifica se o codigo pertence a Roraima."""
        return codigo in cls.MUNICIPIOS_RORAIMA

    @classmethod
    def get_all_roraima_codes(cls) -> tuple[int, ...]:
        """Retorna lista de todos os codigos IBGE de Roraima."""
        return cls.MUNICIPIOS_RORAIMA

    def __str__(self) -> str:
        return str(self.valor)

    def __int__(self) -> int:
        return self.valor
```

## Testes TDD (Escrever PRIMEIRO)

```python
# tests/unit/domain/value_objects/test_codigo_ibge.py
import pytest
from backend.shared.domain.value_objects.codigo_ibge import CodigoIBGE


class TestCodigoIBGE:
    """Testes para Value Object CodigoIBGE."""

    class TestCreate:
        """Testes para factory method create()."""

        def test_deve_criar_codigo_ibge_valido_para_boa_vista(self):
            """Codigo 1400100 (Boa Vista) deve ser aceito."""
            result = CodigoIBGE.create(1400100)

            assert result.is_success
            assert result.value.valor == 1400100

        def test_deve_criar_codigo_ibge_valido_para_todos_municipios_rr(self):
            """Todos os 15 municipios de Roraima devem ser aceitos."""
            municipios = [
                1400050,  # Alto Alegre
                1400027,  # Amajari
                1400100,  # Boa Vista
                1400159,  # Bonfim
                1400175,  # Canta
                1400209,  # Caracarai
                1400233,  # Caroebe
                1400282,  # Iracema
                1400308,  # Mucajai
                1400407,  # Normandia
                1400456,  # Pacaraima
                1400472,  # Rorainopolis
                1400506,  # Sao Joao da Baliza
                1400605,  # Sao Luiz
                1400704,  # Uiramuta
            ]

            for codigo in municipios:
                result = CodigoIBGE.create(codigo)
                assert result.is_success, f"Falhou para {codigo}"

        def test_deve_rejeitar_codigo_com_menos_de_7_digitos(self):
            """Codigo com menos de 7 digitos e invalido (< 1000000)."""
            result = CodigoIBGE.create(140010)  # 6 digitos

            assert result.is_failure
            assert "invalido" in result.error.lower()

        def test_deve_rejeitar_codigo_com_mais_de_7_digitos(self):
            """Codigo com mais de 7 digitos e invalido (> 9999999)."""
            result = CodigoIBGE.create(14001001)  # 8 digitos

            assert result.is_failure
            assert "invalido" in result.error.lower()

        def test_deve_rejeitar_codigo_de_outro_estado(self):
            """Codigo de outro estado (nao RR) deve ser rejeitado."""
            result = CodigoIBGE.create(3550308)  # Sao Paulo

            assert result.is_failure
            assert "Roraima" in result.error

        def test_deve_rejeitar_codigo_inexistente_de_roraima(self):
            """Codigo com prefixo 14 mas inexistente deve ser rejeitado."""
            result = CodigoIBGE.create(1499999)  # Nao existe

            assert result.is_failure
            assert "Roraima" in result.error

    class TestCreateUnsafe:
        """Testes para factory method create_unsafe()."""

        def test_deve_criar_codigo_sem_validacao(self):
            """create_unsafe() cria sem validar (para dados do banco)."""
            ibge = CodigoIBGE.create_unsafe(1400100)

            assert ibge.valor == 1400100

    class TestGetAllRoraimaCodes:
        """Testes para metodo get_all_roraima_codes()."""

        def test_deve_retornar_15_codigos(self):
            """Deve retornar os 15 municipios de Roraima."""
            codes = CodigoIBGE.get_all_roraima_codes()

            assert len(codes) == 15

        def test_deve_retornar_tupla_de_inteiros(self):
            """Deve retornar tuple[int, ...]."""
            codes = CodigoIBGE.get_all_roraima_codes()

            assert isinstance(codes, tuple)
            assert all(isinstance(c, int) for c in codes)

    class TestEquality:
        """Testes para igualdade de Value Objects."""

        def test_codigos_iguais_sao_iguais(self):
            """Dois VOs com mesmo valor sao iguais."""
            ibge1 = CodigoIBGE.create(1400100).value
            ibge2 = CodigoIBGE.create(1400100).value

            assert ibge1 == ibge2

        def test_codigos_diferentes_sao_diferentes(self):
            """Dois VOs com valores diferentes nao sao iguais."""
            ibge1 = CodigoIBGE.create(1400100).value  # Boa Vista
            ibge2 = CodigoIBGE.create(1400209).value  # Caracarai

            assert ibge1 != ibge2

        def test_pode_ser_usado_em_set(self):
            """Value Object pode ser usado em set."""
            ibge1 = CodigoIBGE.create(1400100).value
            ibge2 = CodigoIBGE.create(1400100).value

            s = {ibge1, ibge2}

            assert len(s) == 1

        def test_pode_ser_usado_como_chave_dict(self):
            """Value Object pode ser chave de dicionario."""
            ibge = CodigoIBGE.create(1400100).value

            d = {ibge: "Boa Vista"}

            assert d[ibge] == "Boa Vista"

    class TestStringRepresentation:
        """Testes para representacao string."""

        def test_str_retorna_valor(self):
            """__str__ retorna o valor do codigo como string."""
            ibge = CodigoIBGE.create(1400100).value

            assert str(ibge) == "1400100"

        def test_int_retorna_valor_numerico(self):
            """__int__ retorna o valor como inteiro."""
            ibge = CodigoIBGE.create(1400100).value

            assert int(ibge) == 1400100

    class TestImutabilidade:
        """Testes de imutabilidade (frozen dataclass)."""

        def test_nao_deve_permitir_alteracao_de_valor(self):
            """Value Object deve ser imutavel."""
            ibge = CodigoIBGE.create(1400100).value

            with pytest.raises(AttributeError):
                ibge.valor = 1400050
```

## Criterios de Aceite

- [x] Testes escritos e passando
- [x] Dataclass frozen + slots (imutavel e otimizado)
- [x] Validacao de 7 digitos (1000000 <= valor <= 9999999)
- [x] Validacao de pertencer a Roraima
- [x] Factory method `create(int)` com Result
- [x] Factory method `create_unsafe(int)` para dados do banco
- [x] Metodo `get_all_roraima_codes()` para lista completa
- [x] Lista de municipios como `tuple[int, ...]` (otimizado)
- [x] Tipo `int` conforme spec ANEEL
- [ ] Cobertura >= 90%

## Comando de Execucao

```bash
# Executar testes (RED - devem falhar primeiro)
pytest tests/unit/domain/value_objects/test_codigo_ibge.py -v

# Apos implementacao (GREEN)
pytest tests/unit/domain/value_objects/test_codigo_ibge.py -v --tb=short

# Com cobertura
pytest tests/unit/domain/value_objects/test_codigo_ibge.py --cov=shared/domain/value_objects/codigo_ibge --cov-report=term-missing
```
