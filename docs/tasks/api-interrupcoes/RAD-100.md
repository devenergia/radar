# RAD-100: Value Object CodigoIBGE

**Fase:** 1 - Domain Layer
**Tipo:** Domain
**Prioridade:** Alta
**Status:** Existente
**Dependencias:** -

## Objetivo

Criar Value Object imutavel para codigo IBGE de municipio, com validacao de pertencer a Roraima.

## Localizacao

`backend/shared/domain/value_objects/codigo_ibge.py`

## Especificacao

### Regras de Validacao

1. Codigo deve ter exatamente 7 digitos
2. Codigo deve ser numerico (apenas digitos)
3. Codigo deve pertencer a Roraima (prefixo 14)
4. Codigo deve estar na lista de municipios validos

### Municipios de Roraima (15)

| Codigo IBGE | Municipio |
|-------------|-----------|
| 1400050 | Alto Alegre |
| 1400027 | Amajari |
| 1400100 | Boa Vista |
| 1400159 | Bonfim |
| 1400175 | Canta |
| 1400209 | Caracarai |
| 1400233 | Caroebe |
| 1400282 | Iracema |
| 1400308 | Mucajai |
| 1400407 | Normandia |
| 1400456 | Pacaraima |
| 1400472 | Rorainopolis |
| 1400506 | Sao Joao da Baliza |
| 1400605 | Sao Luiz |
| 1400704 | Uiramuta |

## Implementacao

```python
# shared/domain/value_objects/codigo_ibge.py
from dataclasses import dataclass
from ..result import Result


@dataclass(frozen=True)
class CodigoIBGE:
    """Value Object para codigo IBGE de municipio de Roraima."""

    valor: str

    MUNICIPIOS_RORAIMA = frozenset([
        "1400050",  # Alto Alegre
        "1400027",  # Amajari
        "1400100",  # Boa Vista
        "1400159",  # Bonfim
        "1400175",  # Canta
        "1400209",  # Caracarai
        "1400233",  # Caroebe
        "1400282",  # Iracema
        "1400308",  # Mucajai
        "1400407",  # Normandia
        "1400456",  # Pacaraima
        "1400472",  # Rorainopolis
        "1400506",  # Sao Joao da Baliza
        "1400605",  # Sao Luiz
        "1400704",  # Uiramuta
    ])

    def __post_init__(self) -> None:
        """Validacao no momento da criacao."""
        if not self._is_valid():
            raise ValueError(f"Codigo IBGE invalido: {self.valor}")
        if not self._is_roraima():
            raise ValueError(f"Codigo IBGE nao pertence a Roraima: {self.valor}")

    def _is_valid(self) -> bool:
        """Verifica se codigo tem 7 digitos numericos."""
        return self.valor.isdigit() and len(self.valor) == 7

    def _is_roraima(self) -> bool:
        """Verifica se codigo pertence a Roraima."""
        return self.valor in self.MUNICIPIOS_RORAIMA

    @classmethod
    def create(cls, codigo: str | int) -> "Result[CodigoIBGE]":
        """Factory method com validacao."""
        try:
            valor = str(codigo).zfill(7)
            return Result.ok(cls(valor=valor))
        except ValueError as e:
            return Result.fail(str(e))

    def __str__(self) -> str:
        return self.valor

    def __int__(self) -> int:
        return int(self.valor)
```

## Testes TDD (Escrever PRIMEIRO)

```python
# tests/unit/domain/value_objects/test_codigo_ibge.py
import pytest
from shared.domain.value_objects.codigo_ibge import CodigoIBGE


class TestCodigoIBGE:
    """Testes para Value Object CodigoIBGE."""

    class TestCreate:
        """Testes para factory method create()."""

        def test_deve_criar_codigo_ibge_valido_para_boa_vista(self):
            """Codigo 1400100 (Boa Vista) deve ser aceito."""
            result = CodigoIBGE.create("1400100")

            assert result.is_success
            assert result.value.valor == "1400100"

        def test_deve_criar_codigo_ibge_valido_para_todos_municipios_rr(self):
            """Todos os 15 municipios de Roraima devem ser aceitos."""
            municipios = [
                "1400050",  # Alto Alegre
                "1400027",  # Amajari
                "1400100",  # Boa Vista
                "1400159",  # Bonfim
                "1400175",  # Canta
                "1400209",  # Caracarai
                "1400233",  # Caroebe
                "1400282",  # Iracema
                "1400308",  # Mucajai
                "1400407",  # Normandia
                "1400456",  # Pacaraima
                "1400472",  # Rorainopolis
                "1400506",  # Sao Joao da Baliza
                "1400605",  # Sao Luiz
                "1400704",  # Uiramuta
            ]

            for codigo in municipios:
                result = CodigoIBGE.create(codigo)
                assert result.is_success, f"Falhou para {codigo}"

        def test_deve_aceitar_codigo_como_inteiro(self):
            """Codigo pode ser passado como int."""
            result = CodigoIBGE.create(1400100)

            assert result.is_success
            assert result.value.valor == "1400100"

        def test_deve_adicionar_zeros_a_esquerda(self):
            """Codigo com menos de 7 digitos deve ser preenchido."""
            result = CodigoIBGE.create("1400027")  # Amajari

            assert result.is_success
            assert len(result.value.valor) == 7

        def test_deve_rejeitar_codigo_com_menos_de_7_digitos(self):
            """Codigo com menos de 7 digitos e invalido."""
            result = CodigoIBGE.create("140010")  # 6 digitos

            assert result.is_failure
            assert "invalido" in result.error.lower()

        def test_deve_rejeitar_codigo_com_mais_de_7_digitos(self):
            """Codigo com mais de 7 digitos e invalido."""
            result = CodigoIBGE.create("14001001")  # 8 digitos

            assert result.is_failure
            assert "invalido" in result.error.lower()

        def test_deve_rejeitar_codigo_com_letras(self):
            """Codigo deve conter apenas digitos."""
            result = CodigoIBGE.create("140010A")

            assert result.is_failure

        def test_deve_rejeitar_codigo_de_outro_estado(self):
            """Codigo de outro estado (nao RR) deve ser rejeitado."""
            result = CodigoIBGE.create("3550308")  # Sao Paulo

            assert result.is_failure
            assert "Roraima" in result.error

        def test_deve_rejeitar_codigo_inexistente_de_roraima(self):
            """Codigo com prefixo 14 mas inexistente deve ser rejeitado."""
            result = CodigoIBGE.create("1499999")  # Nao existe

            assert result.is_failure

    class TestEquality:
        """Testes para igualdade de Value Objects."""

        def test_codigos_iguais_sao_iguais(self):
            """Dois VOs com mesmo valor sao iguais."""
            ibge1 = CodigoIBGE.create("1400100").value
            ibge2 = CodigoIBGE.create("1400100").value

            assert ibge1 == ibge2

        def test_codigos_diferentes_sao_diferentes(self):
            """Dois VOs com valores diferentes nao sao iguais."""
            ibge1 = CodigoIBGE.create("1400100").value  # Boa Vista
            ibge2 = CodigoIBGE.create("1400209").value  # Caracarai

            assert ibge1 != ibge2

        def test_pode_ser_usado_em_set(self):
            """Value Object pode ser usado em set."""
            ibge1 = CodigoIBGE.create("1400100").value
            ibge2 = CodigoIBGE.create("1400100").value

            s = {ibge1, ibge2}

            assert len(s) == 1

        def test_pode_ser_usado_como_chave_dict(self):
            """Value Object pode ser chave de dicionario."""
            ibge = CodigoIBGE.create("1400100").value

            d = {ibge: "Boa Vista"}

            assert d[ibge] == "Boa Vista"

    class TestStringRepresentation:
        """Testes para representacao string."""

        def test_str_retorna_valor(self):
            """__str__ retorna o valor do codigo."""
            ibge = CodigoIBGE.create("1400100").value

            assert str(ibge) == "1400100"

        def test_int_retorna_valor_numerico(self):
            """__int__ retorna o valor como inteiro."""
            ibge = CodigoIBGE.create("1400100").value

            assert int(ibge) == 1400100
```

## Criterios de Aceite

- [ ] Testes escritos e passando
- [ ] Dataclass frozen (imutavel)
- [ ] Validacao de 7 digitos
- [ ] Validacao de pertencer a Roraima
- [ ] Factory method create() com Result
- [ ] Lista de municipios completa
- [ ] Cobertura >= 90%

## Comando de Execucao

```bash
# Executar testes (RED - devem falhar primeiro)
pytest tests/unit/domain/value_objects/test_codigo_ibge.py -v

# Apos implementacao (GREEN)
pytest tests/unit/domain/value_objects/test_codigo_ibge.py -v --tb=short

# Com cobertura
pytest tests/unit/domain/value_objects/test_codigo_ibge.py --cov=shared/domain/value_objects/codigo_ibge --cov-report=term-missing
```
