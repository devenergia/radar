# RAD-121: Testes E2E - API

**Fase:** 5 - Testes TDD
**Tipo:** Test
**Prioridade:** Critica
**Status:** Pendente
**Dependencias:** RAD-116

## Objetivo

Criar testes end-to-end (E2E) para os endpoints da API de Interrupcoes.

## IMPORTANTE: Padroes do Projeto

- Testes ANTES do codigo (TDD)
- Markers: `@pytest.mark.e2e`
- Usar httpx.AsyncClient
- Testar formato de resposta ANEEL
- Testar autenticacao e erros HTTP

## Testes a Implementar

```python
# backend/tests/e2e/api/test_interrupcoes.py
import pytest
from httpx import AsyncClient
from fastapi import status

from apps.api_interrupcoes.main import create_app


class TestQuantitativoInterrupcoesAtivas:
    """Testes E2E para endpoint /quantitativointerrupcoesativas."""

    @pytest.fixture
    def app(self):
        """Cria instancia da aplicacao."""
        return create_app()

    @pytest.fixture
    async def client(self, app):
        """Cliente HTTP para testes."""
        async with AsyncClient(app=app, base_url="http://test") as client:
            yield client

    @pytest.fixture
    def api_key(self):
        """API Key valida para testes."""
        return "test-api-key"

    class TestAutenticacao:
        """Testes de autenticacao."""

        @pytest.mark.e2e
        @pytest.mark.asyncio
        async def test_deve_retornar_401_sem_api_key(self, client):
            """Requisicao sem x-api-key deve retornar 401."""
            # Act
            response = await client.get("/quantitativointerrupcoesativas")

            # Assert
            assert response.status_code == status.HTTP_401_UNAUTHORIZED

        @pytest.mark.e2e
        @pytest.mark.asyncio
        async def test_deve_retornar_401_com_api_key_invalida(self, client):
            """Requisicao com x-api-key invalida deve retornar 401."""
            # Act
            response = await client.get(
                "/quantitativointerrupcoesativas",
                headers={"x-api-key": "chave-invalida"}
            )

            # Assert
            assert response.status_code == status.HTTP_401_UNAUTHORIZED

        @pytest.mark.e2e
        @pytest.mark.asyncio
        async def test_deve_retornar_200_com_api_key_valida(
            self, client, api_key
        ):
            """Requisicao com x-api-key valida deve retornar 200."""
            # Act
            response = await client.get(
                "/quantitativointerrupcoesativas",
                headers={"x-api-key": api_key}
            )

            # Assert
            assert response.status_code == status.HTTP_200_OK

    class TestFormatoResposta:
        """Testes do formato de resposta ANEEL."""

        @pytest.mark.e2e
        @pytest.mark.asyncio
        async def test_deve_retornar_formato_aneel(self, client, api_key):
            """Resposta deve seguir formato especificado pela ANEEL."""
            # Act
            response = await client.get(
                "/quantitativointerrupcoesativas",
                headers={"x-api-key": api_key}
            )

            # Assert
            data = response.json()
            assert "idcStatusRequisicao" in data
            assert "emailIndisponibilidade" in data
            assert "mensagem" in data
            assert "interrupcaoFornecimento" in data

        @pytest.mark.e2e
        @pytest.mark.asyncio
        async def test_status_sucesso_deve_ser_1(self, client, api_key):
            """idcStatusRequisicao deve ser 1 para sucesso."""
            # Act
            response = await client.get(
                "/quantitativointerrupcoesativas",
                headers={"x-api-key": api_key}
            )

            # Assert
            data = response.json()
            assert data["idcStatusRequisicao"] == 1

        @pytest.mark.e2e
        @pytest.mark.asyncio
        async def test_email_deve_estar_configurado(self, client, api_key):
            """emailIndisponibilidade deve ter valor configurado."""
            # Act
            response = await client.get(
                "/quantitativointerrupcoesativas",
                headers={"x-api-key": api_key}
            )

            # Assert
            data = response.json()
            assert data["emailIndisponibilidade"] != ""
            assert "@" in data["emailIndisponibilidade"]

        @pytest.mark.e2e
        @pytest.mark.asyncio
        async def test_mensagem_deve_ser_vazia_para_sucesso(
            self, client, api_key
        ):
            """mensagem deve ser vazia quando sucesso."""
            # Act
            response = await client.get(
                "/quantitativointerrupcoesativas",
                headers={"x-api-key": api_key}
            )

            # Assert
            data = response.json()
            assert data["mensagem"] == ""

        @pytest.mark.e2e
        @pytest.mark.asyncio
        async def test_interrupcaoFornecimento_deve_ser_lista(
            self, client, api_key
        ):
            """interrupcaoFornecimento deve ser uma lista."""
            # Act
            response = await client.get(
                "/quantitativointerrupcoesativas",
                headers={"x-api-key": api_key}
            )

            # Assert
            data = response.json()
            assert isinstance(data["interrupcaoFornecimento"], list)

    class TestCamposItem:
        """Testes dos campos de cada item de interrupcao."""

        @pytest.mark.e2e
        @pytest.mark.asyncio
        async def test_item_deve_ter_campos_obrigatorios(
            self, client, api_key
        ):
            """Cada item deve ter todos os campos obrigatorios."""
            # Act
            response = await client.get(
                "/quantitativointerrupcoesativas",
                headers={"x-api-key": api_key}
            )

            # Assert
            data = response.json()
            if data["interrupcaoFornecimento"]:
                item = data["interrupcaoFornecimento"][0]
                assert "ideConjuntoUnidadeConsumidora" in item
                assert "ideMunicipio" in item
                assert "qtdUCsAtendidas" in item
                assert "qtdOcorrenciaProgramada" in item
                assert "qtdOcorrenciaNaoProgramada" in item

        @pytest.mark.e2e
        @pytest.mark.asyncio
        async def test_ideMunicipio_deve_ser_codigo_roraima(
            self, client, api_key
        ):
            """ideMunicipio deve ser codigo IBGE de Roraima (14xxxxx)."""
            # Act
            response = await client.get(
                "/quantitativointerrupcoesativas",
                headers={"x-api-key": api_key}
            )

            # Assert
            data = response.json()
            for item in data["interrupcaoFornecimento"]:
                municipio = str(item["ideMunicipio"])
                assert municipio.startswith("14")
                assert len(municipio) == 7

        @pytest.mark.e2e
        @pytest.mark.asyncio
        async def test_quantidades_devem_ser_inteiros_positivos(
            self, client, api_key
        ):
            """Campos de quantidade devem ser inteiros >= 0."""
            # Act
            response = await client.get(
                "/quantitativointerrupcoesativas",
                headers={"x-api-key": api_key}
            )

            # Assert
            data = response.json()
            for item in data["interrupcaoFornecimento"]:
                assert isinstance(item["qtdUCsAtendidas"], int)
                assert isinstance(item["qtdOcorrenciaProgramada"], int)
                assert isinstance(item["qtdOcorrenciaNaoProgramada"], int)
                assert item["qtdUCsAtendidas"] >= 0
                assert item["qtdOcorrenciaProgramada"] >= 0
                assert item["qtdOcorrenciaNaoProgramada"] >= 0


class TestHealthCheck:
    """Testes E2E para endpoint /health."""

    @pytest.fixture
    def app(self):
        return create_app()

    @pytest.fixture
    async def client(self, app):
        async with AsyncClient(app=app, base_url="http://test") as client:
            yield client

    @pytest.mark.e2e
    @pytest.mark.asyncio
    async def test_health_deve_retornar_200(self, client):
        """Health check deve retornar 200."""
        # Act
        response = await client.get("/health")

        # Assert
        assert response.status_code == status.HTTP_200_OK

    @pytest.mark.e2e
    @pytest.mark.asyncio
    async def test_health_deve_retornar_status_healthy(self, client):
        """Health check deve retornar status healthy."""
        # Act
        response = await client.get("/health")

        # Assert
        data = response.json()
        assert data["status"] == "healthy"

    @pytest.mark.e2e
    @pytest.mark.asyncio
    async def test_health_nao_requer_autenticacao(self, client):
        """Health check nao deve requerer x-api-key."""
        # Act
        response = await client.get("/health")
        # Sem header x-api-key

        # Assert
        assert response.status_code == status.HTTP_200_OK


class TestRoot:
    """Testes E2E para endpoint raiz /."""

    @pytest.fixture
    def app(self):
        return create_app()

    @pytest.fixture
    async def client(self, app):
        async with AsyncClient(app=app, base_url="http://test") as client:
            yield client

    @pytest.mark.e2e
    @pytest.mark.asyncio
    async def test_root_deve_retornar_200(self, client):
        """Endpoint raiz deve retornar 200."""
        # Act
        response = await client.get("/")

        # Assert
        assert response.status_code == status.HTTP_200_OK

    @pytest.mark.e2e
    @pytest.mark.asyncio
    async def test_root_deve_retornar_info_api(self, client):
        """Endpoint raiz deve retornar informacoes da API."""
        # Act
        response = await client.get("/")

        # Assert
        data = response.json()
        assert "service" in data or "name" in data
        assert "version" in data
```

## Arquivo de Saida

`backend/tests/e2e/api/test_interrupcoes.py`

## Criterios de Aceite

- [ ] Testes de autenticacao implementados (401)
- [ ] Testes de formato ANEEL implementados
- [ ] Testes de campos obrigatorios implementados
- [ ] Testes de health check implementados
- [ ] Markers @pytest.mark.e2e
- [ ] Uso de httpx.AsyncClient
- [ ] Todos os testes passando

## Comandos de Execucao

```bash
# Executar testes E2E
pytest backend/tests/e2e/ -v -m e2e

# Com verbose
pytest backend/tests/e2e/api/test_interrupcoes.py -v --tb=short
```

## Agentes Recomendados

- `@test-engineer` - Para implementar os testes
- `@backend-architect` - Para validar endpoints
