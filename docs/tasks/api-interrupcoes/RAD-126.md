# RAD-126: Configurar Alembic para Migracoes

**Fase:** 7 - Infraestrutura de Dados
**Tipo:** Infrastructure
**Prioridade:** Alta
**Status:** Concluido
**Dependencias:** RAD-108

## Objetivo

Configurar o Alembic como ferramenta de migracao de banco de dados para o projeto RADAR, permitindo versionamento e rollback de alteracoes no schema Oracle.

## Localizacao

`backend/shared/infrastructure/database/migrations/`

## Especificacao

### Requisitos

1. Versionamento de schema Oracle
2. Rollback de alteracoes
3. Consistencia entre ambientes (dev, hm, prd)
4. Integracao com Settings existente (RAD-111)

### Estrutura de Arquivos

```
backend/shared/infrastructure/database/
├── migrations/
│   ├── env.py              # Configuracao do Alembic
│   ├── script.py.mako      # Template de migracoes
│   └── versions/           # Arquivos de migracao
│       ├── 20251219_001_*.py
│       └── 20251219_002_*.py
├── models.py               # SQLAlchemy models
└── oracle_connection.py    # Conexao existente
```

## Implementacao

```python
# backend/shared/infrastructure/database/migrations/env.py
from alembic import context
from sqlalchemy import engine_from_config, pool

from backend.shared.infrastructure.config import get_settings
from backend.shared.infrastructure.database.models import Base

target_metadata = Base.metadata


def get_url() -> str:
    """Retorna URL de conexao Oracle."""
    settings = get_settings()
    return (
        f"oracle+oracledb://{settings.db_user}:{settings.db_password}"
        f"@{settings.db_host}:{settings.db_port}/{settings.db_service}"
    )


def run_migrations_online() -> None:
    """Executa migracoes em modo online."""
    configuration = context.config.get_section(context.config.config_ini_section)
    configuration["sqlalchemy.url"] = get_url()

    connectable = engine_from_config(
        configuration,
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(connection=connection, target_metadata=target_metadata)
        with context.begin_transaction():
            context.run_migrations()
```

## Testes TDD (Escrever PRIMEIRO)

```python
# tests/unit/infrastructure/test_alembic_config.py
import pytest
from pathlib import Path


class TestAlembicConfig:
    """Testes para configuracao do Alembic."""

    def test_deve_existir_alembic_ini(self):
        """Arquivo alembic.ini deve existir na raiz."""
        assert Path("alembic.ini").exists()

    def test_deve_existir_env_py(self):
        """Arquivo env.py deve existir em migrations."""
        path = Path("backend/shared/infrastructure/database/migrations/env.py")
        assert path.exists()

    def test_deve_existir_diretorio_versions(self):
        """Diretorio versions deve existir."""
        path = Path("backend/shared/infrastructure/database/migrations/versions")
        assert path.exists()
```

## Criterios de Aceite

- [x] Alembic adicionado ao pyproject.toml
- [x] alembic.ini configurado para Oracle
- [x] Estrutura de migrations criada
- [x] env.py configurado para usar Settings do projeto
- [x] script.py.mako customizado
- [ ] Comandos documentados no README

## Comando de Execucao

```bash
# Criar nova migracao
alembic revision --autogenerate -m "descricao"

# Aplicar migracoes pendentes
alembic upgrade head

# Reverter ultima migracao
alembic downgrade -1

# Ver historico
alembic history
```

## Relacionamento com Outras Tasks

- **RAD-108** (Oracle Connection): Usa a mesma configuracao de conexao
- **RAD-111** (Settings/Config): Usa Settings para credenciais
- **RAD-127** (Tabelas Auditoria): Primeira migracao criada
- **RAD-128** (View Interrupcoes): Segunda migracao criada
