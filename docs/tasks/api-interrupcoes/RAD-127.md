# RAD-127: Criar Tabelas de Auditoria

**Fase:** 7 - Infraestrutura de Dados
**Tipo:** Database
**Prioridade:** Alta
**Status:** Concluido
**Dependencias:** RAD-126

## Objetivo

Criar tabelas de auditoria no Oracle para persistir tokens de acesso e registros de consultas, complementando a validacao em aplicacao (RAD-122) e logging (RAD-124).

## Localizacao

`backend/shared/infrastructure/database/migrations/versions/20251219_001_create_audit_tables.py`

## Especificacao

### Contexto

Para atender requisitos de auditoria da ANEEL, e necessario registrar todas as consultas realizadas na API, incluindo tokens utilizados e snapshots dos dados.

**Complementa:**
- **RAD-122** (API Key Authentication): Valida tokens na aplicacao, esta task persiste no banco
- **RAD-124** (Logging e Auditoria): Faz logging em arquivos, esta task persiste no banco

### Schema das Tabelas

#### TOKEN_ACESSO

```sql
CREATE TABLE RADAR_API.TOKEN_ACESSO (
    ID VARCHAR2(100) PRIMARY KEY,
    NOME VARCHAR2(300) NOT NULL,
    DESCRICAO VARCHAR2(500),
    CHAVE VARCHAR2(100) NOT NULL UNIQUE,
    ATIVO CHAR(1) DEFAULT 'S' CHECK (ATIVO IN ('S', 'N')),
    DATA_CRIACAO DATE DEFAULT SYSDATE,
    DATA_EXPIRACAO DATE,
    ULTIMO_ACESSO DATE,
    TOTAL_ACESSOS NUMBER DEFAULT 0,
    IP_ORIGEM_PERMITIDO VARCHAR2(500)
);
```

#### TIPO_CONSULTA

```sql
CREATE TABLE RADAR_API.TIPO_CONSULTA (
    ID NUMBER PRIMARY KEY,
    CODIGO VARCHAR2(50) NOT NULL UNIQUE,
    DESCRICAO VARCHAR2(200) NOT NULL,
    ATIVO CHAR(1) DEFAULT 'S'
);
```

#### CONSULTA

```sql
CREATE TABLE RADAR_API.CONSULTA (
    ID VARCHAR2(100) PRIMARY KEY,
    ID_TOKEN VARCHAR2(100) REFERENCES TOKEN_ACESSO(ID),
    ID_TIPO_CONSULTA NUMBER NOT NULL REFERENCES TIPO_CONSULTA(ID),
    DATA_BRASILIA DATE NOT NULL,
    DATA_INICIO DATE DEFAULT SYSDATE,
    DATA_FIM DATE,
    PARAMETROS CLOB,
    IP_ORIGEM VARCHAR2(50),
    STATUS VARCHAR2(20) DEFAULT 'PROCESSANDO',
    MENSAGEM_ERRO CLOB
);
```

#### INTERRUPCAO_ATIVA

```sql
CREATE TABLE RADAR_API.INTERRUPCAO_ATIVA (
    ID NUMBER PRIMARY KEY,
    ID_CONSULTA VARCHAR2(100) NOT NULL REFERENCES CONSULTA(ID),
    ID_CONJUNTO_UC NUMBER NOT NULL,
    ID_MUNICIPIO NUMBER NOT NULL,
    QTD_UCS_ATENDIDAS NUMBER DEFAULT 0,
    QTD_PROGRAMADA NUMBER DEFAULT 0,
    QTD_NAO_PROGRAMADA NUMBER DEFAULT 0
);
```

## Implementacao

```python
# migrations/versions/20251219_001_create_audit_tables.py
from alembic import op
import sqlalchemy as sa

SCHEMA = "RADAR_API"

def upgrade() -> None:
    """Cria tabelas de auditoria."""
    # TOKEN_ACESSO
    op.execute(f"""
        CREATE TABLE {SCHEMA}.TOKEN_ACESSO (
            ID VARCHAR2(100) PRIMARY KEY,
            NOME VARCHAR2(300) NOT NULL,
            CHAVE VARCHAR2(100) NOT NULL UNIQUE,
            ATIVO CHAR(1) DEFAULT 'S',
            DATA_CRIACAO DATE DEFAULT SYSDATE
        )
    """)

    # TIPO_CONSULTA com dados iniciais
    op.execute(f"""
        CREATE TABLE {SCHEMA}.TIPO_CONSULTA (
            ID NUMBER PRIMARY KEY,
            CODIGO VARCHAR2(50) NOT NULL UNIQUE,
            DESCRICAO VARCHAR2(200) NOT NULL
        )
    """)

    # Inserir tipos de consulta
    op.execute(f"""
        INSERT INTO {SCHEMA}.TIPO_CONSULTA (ID, CODIGO, DESCRICAO) VALUES
        (1, 'INTERRUPCAO_ATIVA', 'Quantitativo de Interrupcoes Ativas')
    """)

    # CONSULTA
    op.execute(f"""
        CREATE TABLE {SCHEMA}.CONSULTA (
            ID VARCHAR2(100) PRIMARY KEY,
            ID_TOKEN VARCHAR2(100) REFERENCES {SCHEMA}.TOKEN_ACESSO(ID),
            ID_TIPO_CONSULTA NUMBER NOT NULL REFERENCES {SCHEMA}.TIPO_CONSULTA(ID),
            DATA_INICIO DATE DEFAULT SYSDATE,
            STATUS VARCHAR2(20) DEFAULT 'PROCESSANDO'
        )
    """)


def downgrade() -> None:
    """Remove tabelas de auditoria."""
    op.execute(f"DROP TABLE {SCHEMA}.CONSULTA")
    op.execute(f"DROP TABLE {SCHEMA}.TIPO_CONSULTA")
    op.execute(f"DROP TABLE {SCHEMA}.TOKEN_ACESSO")
```

## Testes TDD (Escrever PRIMEIRO)

```python
# tests/integration/database/test_audit_tables.py
import pytest
from sqlalchemy import text


@pytest.mark.integration
class TestAuditTables:
    """Testes para tabelas de auditoria."""

    def test_deve_existir_tabela_token_acesso(self, db_session):
        """Tabela TOKEN_ACESSO deve existir."""
        result = db_session.execute(text(
            "SELECT COUNT(*) FROM user_tables WHERE table_name = 'TOKEN_ACESSO'"
        ))
        assert result.scalar() == 1

    def test_deve_existir_tabela_consulta(self, db_session):
        """Tabela CONSULTA deve existir."""
        result = db_session.execute(text(
            "SELECT COUNT(*) FROM user_tables WHERE table_name = 'CONSULTA'"
        ))
        assert result.scalar() == 1

    def test_tipo_consulta_deve_ter_dados_iniciais(self, db_session):
        """TIPO_CONSULTA deve ter dados iniciais."""
        result = db_session.execute(text(
            "SELECT COUNT(*) FROM RADAR_API.TIPO_CONSULTA"
        ))
        assert result.scalar() >= 1
```

## Criterios de Aceite

- [x] Migracao criada com Alembic
- [x] Tabelas criadas no schema RADAR_API
- [x] Indices criados para campos de busca
- [x] Foreign Keys configuradas
- [x] Dados iniciais de TIPO_CONSULTA inseridos
- [x] Rollback (downgrade) funcionando

## Comando de Execucao

```bash
# Aplicar migracao
alembic upgrade head

# Verificar tabelas
SELECT table_name FROM user_tables WHERE table_name LIKE 'TOKEN%';

# Reverter se necessario
alembic downgrade -1
```

## Relacionamento com Outras Tasks

- **RAD-122** (API Key Auth): Token validado em app, persistido aqui
- **RAD-124** (Logging): Logs em arquivo, consultas persistidas aqui
- **RAD-126** (Alembic): Usa infraestrutura de migracoes
- **RAD-129** (Entity Consulta): Entity de dominio para estas tabelas
