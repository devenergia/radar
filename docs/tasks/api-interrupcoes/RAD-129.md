# RAD-129: Implementar Entity Consulta

**Fase:** 7 - Infraestrutura de Dados
**Tipo:** Domain
**Prioridade:** Alta
**Status:** Pendente
**Dependencias:** RAD-103, RAD-127

## Objetivo

Implementar Entity Consulta no dominio seguindo DDD, representando uma requisicao realizada na API para auditoria e rastreabilidade.

## Localizacao

`backend/shared/domain/entities/consulta.py`

## Especificacao

### Contexto

A Entity Consulta representa uma requisicao realizada na API, permitindo rastreabilidade completa para auditoria da ANEEL.

**Complementa:**
- **RAD-124** (Logging e Auditoria): Logs em arquivo, Entity persiste no banco
- **RAD-127** (Tabelas Auditoria): Tabela CONSULTA, esta task e a Entity de dominio
- **RAD-102** (Entity Interrupcao): Segue mesmo padrao de Entity

### Ciclo de Vida

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  INICIAR    │────>│ PROCESSANDO │────>│   SUCESSO   │
│  Consulta   │     │             │     │             │
└─────────────┘     └──────┬──────┘     └─────────────┘
                          │
                          │ erro
                          ▼
                   ┌─────────────┐
                   │    ERRO     │
                   │             │
                   └─────────────┘
```

## Implementacao

```python
# backend/shared/domain/entities/consulta.py
from dataclasses import dataclass
from datetime import datetime
from enum import Enum
from typing import Optional
from uuid import uuid4

from backend.shared.domain.result import Result


class StatusConsulta(Enum):
    """Status do ciclo de vida da consulta."""
    PROCESSANDO = "PROCESSANDO"
    SUCESSO = "SUCESSO"
    ERRO = "ERRO"


class TipoConsulta(Enum):
    """Tipos de consulta disponiveis na API."""
    INTERRUPCAO_ATIVA = 1
    DADOS_DEMANDA = 2
    DEMANDAS_DIVERSAS = 3
    TEMPO_REAL = 4


@dataclass
class Consulta:
    """
    Entity que representa uma consulta na API para auditoria.

    Attributes:
        id: Identificador unico (UUID)
        tipo: Tipo da consulta
        data_brasilia: Data/hora no fuso de Brasilia
        data_inicio: Timestamp de inicio do processamento
        status: Status atual do ciclo de vida
        id_token: Token utilizado (opcional para consultas anonimas)
        data_fim: Timestamp de fim do processamento
        parametros: JSON com parametros da requisicao
        ip_origem: IP do cliente
        mensagem_erro: Mensagem de erro se status = ERRO
    """

    id: str
    tipo: TipoConsulta
    data_brasilia: datetime
    data_inicio: datetime
    status: StatusConsulta
    id_token: Optional[str] = None
    data_fim: Optional[datetime] = None
    parametros: Optional[str] = None
    ip_origem: Optional[str] = None
    mensagem_erro: Optional[str] = None

    @classmethod
    def iniciar(
        cls,
        tipo: TipoConsulta,
        id_token: Optional[str] = None,
        ip_origem: Optional[str] = None,
        parametros: Optional[str] = None,
    ) -> Result["Consulta"]:
        """
        Factory method para criar nova consulta em status PROCESSANDO.

        Args:
            tipo: Tipo da consulta
            id_token: ID do token de acesso (opcional)
            ip_origem: IP de origem da requisicao
            parametros: Parametros da requisicao em JSON

        Returns:
            Result com Consulta ou erro
        """
        return Result.ok(
            cls(
                id=str(uuid4()),
                tipo=tipo,
                data_brasilia=datetime.now(),
                data_inicio=datetime.now(),
                status=StatusConsulta.PROCESSANDO,
                id_token=id_token,
                ip_origem=ip_origem,
                parametros=parametros,
            )
        )

    def finalizar_sucesso(self) -> None:
        """Marca consulta como finalizada com sucesso."""
        self.data_fim = datetime.now()
        self.status = StatusConsulta.SUCESSO

    def finalizar_erro(self, mensagem: str) -> None:
        """Marca consulta como finalizada com erro."""
        self.data_fim = datetime.now()
        self.status = StatusConsulta.ERRO
        self.mensagem_erro = mensagem

    @property
    def duracao_ms(self) -> Optional[int]:
        """Retorna duracao da consulta em milissegundos."""
        if not self.data_fim:
            return None
        delta = self.data_fim - self.data_inicio
        return int(delta.total_seconds() * 1000)

    def is_finalizada(self) -> bool:
        """Verifica se consulta foi finalizada."""
        return self.status != StatusConsulta.PROCESSANDO

    def is_sucesso(self) -> bool:
        """Verifica se consulta finalizou com sucesso."""
        return self.status == StatusConsulta.SUCESSO
```

## Testes TDD (Escrever PRIMEIRO)

```python
# backend/tests/unit/domain/entities/test_consulta.py
import pytest
from backend.shared.domain.entities.consulta import (
    Consulta, TipoConsulta, StatusConsulta
)


class TestConsulta:
    """Testes para Entity Consulta."""

    class TestIniciar:
        """Testes para factory method iniciar()."""

        def test_deve_criar_consulta_com_status_processando(self):
            """Nova consulta deve iniciar em PROCESSANDO."""
            result = Consulta.iniciar(TipoConsulta.INTERRUPCAO_ATIVA)

            assert result.is_success
            assert result.value.status == StatusConsulta.PROCESSANDO

        def test_deve_gerar_id_unico(self):
            """Cada consulta deve ter ID unico."""
            result1 = Consulta.iniciar(TipoConsulta.INTERRUPCAO_ATIVA)
            result2 = Consulta.iniciar(TipoConsulta.INTERRUPCAO_ATIVA)

            assert result1.value.id != result2.value.id

        def test_deve_registrar_data_inicio(self):
            """Deve registrar data de inicio."""
            result = Consulta.iniciar(TipoConsulta.INTERRUPCAO_ATIVA)

            assert result.value.data_inicio is not None

        def test_deve_aceitar_parametros_opcionais(self):
            """Deve aceitar token, ip e parametros."""
            result = Consulta.iniciar(
                tipo=TipoConsulta.INTERRUPCAO_ATIVA,
                id_token="token-123",
                ip_origem="192.168.1.1",
                parametros='{"filtro": "ativo"}',
            )

            assert result.value.id_token == "token-123"
            assert result.value.ip_origem == "192.168.1.1"
            assert result.value.parametros == '{"filtro": "ativo"}'

    class TestFinalizarSucesso:
        """Testes para finalizar_sucesso()."""

        def test_deve_marcar_status_sucesso(self):
            """Status deve mudar para SUCESSO."""
            consulta = Consulta.iniciar(TipoConsulta.INTERRUPCAO_ATIVA).value

            consulta.finalizar_sucesso()

            assert consulta.status == StatusConsulta.SUCESSO

        def test_deve_registrar_data_fim(self):
            """Deve registrar data de fim."""
            consulta = Consulta.iniciar(TipoConsulta.INTERRUPCAO_ATIVA).value

            consulta.finalizar_sucesso()

            assert consulta.data_fim is not None

    class TestFinalizarErro:
        """Testes para finalizar_erro()."""

        def test_deve_marcar_status_erro(self):
            """Status deve mudar para ERRO."""
            consulta = Consulta.iniciar(TipoConsulta.INTERRUPCAO_ATIVA).value

            consulta.finalizar_erro("Erro de conexao")

            assert consulta.status == StatusConsulta.ERRO

        def test_deve_registrar_mensagem_erro(self):
            """Deve registrar mensagem de erro."""
            consulta = Consulta.iniciar(TipoConsulta.INTERRUPCAO_ATIVA).value

            consulta.finalizar_erro("Erro de conexao")

            assert consulta.mensagem_erro == "Erro de conexao"

    class TestDuracaoMs:
        """Testes para propriedade duracao_ms."""

        def test_deve_retornar_none_se_nao_finalizada(self):
            """Duracao None se consulta em andamento."""
            consulta = Consulta.iniciar(TipoConsulta.INTERRUPCAO_ATIVA).value

            assert consulta.duracao_ms is None

        def test_deve_calcular_duracao_apos_finalizar(self):
            """Deve calcular duracao apos finalizar."""
            consulta = Consulta.iniciar(TipoConsulta.INTERRUPCAO_ATIVA).value

            consulta.finalizar_sucesso()

            assert consulta.duracao_ms is not None
            assert consulta.duracao_ms >= 0
```

## Criterios de Aceite

- [ ] Entity criada em `backend/shared/domain/entities/consulta.py`
- [ ] Factory method `Consulta.iniciar()` retorna Result
- [ ] Metodos `finalizar_sucesso()` e `finalizar_erro()`
- [ ] Property `duracao_ms` calcula tempo de processamento
- [ ] Testes unitarios com cobertura >= 80%
- [ ] Sem imports de infraestrutura (domain puro)

## Comando de Execucao

```bash
# Executar testes (RED)
pytest tests/unit/domain/entities/test_consulta.py -v

# Com cobertura
pytest tests/unit/domain/entities/test_consulta.py --cov=shared/domain/entities/consulta --cov-report=term-missing
```

## Relacionamento com Outras Tasks

- **RAD-102** (Entity Interrupcao): Segue mesmo padrao de Entity
- **RAD-103** (Result Pattern): Usa Result no factory method
- **RAD-124** (Logging e Auditoria): Complementa com persistencia
- **RAD-127** (Tabelas Auditoria): Mapeia para tabela CONSULTA
