# RAD-125: Documentacao OpenAPI

**Fase:** 6 - Seguranca e Compliance
**Tipo:** Documentation
**Prioridade:** Media
**Status:** Pendente
**Dependencias:** RAD-112, RAD-113, RAD-114

## Objetivo

Gerar documentacao OpenAPI completa conforme especificacao ANEEL.

## Localizacao

`docs/api-specs/openapi-api1-interrupcoes.yaml`

## Especificacao

### Requisitos ANEEL

1. Documentacao clara da API
2. Exemplos de requisicao e resposta
3. Codigos de erro documentados
4. Autenticacao descrita
5. Rate limiting documentado

### Estrutura OpenAPI

```yaml
openapi: 3.0.3
info:
  title: API de Quantitativo de Interrupcoes Ativas
  description: API para consulta de interrupcoes de fornecimento
  version: 1.0.0
  contact:
    name: RADAR - Roraima Energia
    email: radar@roraimaenergia.com.br
servers:
  - url: https://api.roraimaenergia.com.br/api/v1/interrupcoes
    description: Producao
paths:
  /quantitativointerrupcoesativas:
    get:
      summary: Consulta interrupcoes ativas
      # ...
```

## Implementacao

```yaml
# docs/api-specs/openapi-api1-interrupcoes.yaml
openapi: 3.0.3
info:
  title: API de Quantitativo de Interrupcoes Ativas - RADAR
  description: |
    API para consulta de quantitativo de interrupcoes ativas de fornecimento
    de energia eletrica, conforme especificacao ANEEL.

    ## Autenticacao

    Todas as requisicoes devem incluir o header `x-api-key` com uma chave valida.

    ## Rate Limiting

    A API permite no maximo **12 requisicoes por minuto** por IP/API Key.
    Recomenda-se um intervalo minimo de 5 minutos entre consultas.

    ## Formato de Resposta

    Todas as respostas seguem o formato padrao ANEEL, incluindo:
    - `idcStatusRequisicao`: 1 (sucesso) ou 2 (erro)
    - `desStatusRequisicao`: Descricao do status
    - `interrupcaoFornecimento`: Lista de dados agregados

  version: 1.0.0
  contact:
    name: Equipe RADAR
    email: radar@roraimaenergia.com.br
  license:
    name: Proprietaria
    url: https://roraimaenergia.com.br

servers:
  - url: https://api.roraimaenergia.com.br/api/v1/interrupcoes
    description: Servidor de Producao
  - url: http://localhost:8001/api/v1/interrupcoes
    description: Servidor de Desenvolvimento

tags:
  - name: Interrupcoes
    description: Operacoes relacionadas a interrupcoes de fornecimento
  - name: Health
    description: Verificacao de saude da API

paths:
  /quantitativointerrupcoesativas:
    get:
      tags:
        - Interrupcoes
      summary: Consulta interrupcoes ativas
      description: |
        Retorna o quantitativo de interrupcoes ativas agregadas por
        municipio e conjunto eletrico.

        Os dados sao cacheados por 5 minutos para otimizacao de performance.
      operationId: getInterrupcoesAtivas
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Consulta realizada com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InterrupcoesAtivasResponse'
              examples:
                com_interrupcoes:
                  summary: Resposta com interrupcoes
                  value:
                    idcStatusRequisicao: 1
                    desStatusRequisicao: Sucesso
                    emailIndisponibilidade: radar@roraimaenergia.com.br
                    mensagem: ""
                    interrupcaoFornecimento:
                      - ideConjuntoUnidadeConsumidora: 1
                        ideMunicipio: "1400100"
                        qtdUCsAtendidas: 85432
                        qtdOcorrenciaProgramada: 234
                        qtdOcorrenciaNaoProgramada: 89
                sem_interrupcoes:
                  summary: Resposta sem interrupcoes
                  value:
                    idcStatusRequisicao: 1
                    desStatusRequisicao: Sucesso
                    emailIndisponibilidade: radar@roraimaenergia.com.br
                    mensagem: "Nenhuma interrupcao ativa no momento"
                    interrupcaoFornecimento: []
        '401':
          description: Autenticacao falhou
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                sem_api_key:
                  summary: API Key ausente
                  value:
                    idcStatusRequisicao: 2
                    desStatusRequisicao: Autenticacao necessaria
                    emailIndisponibilidade: radar@roraimaenergia.com.br
                    mensagem: Header x-api-key nao fornecido
                    interrupcaoFornecimento: []
                api_key_invalida:
                  summary: API Key invalida
                  value:
                    idcStatusRequisicao: 2
                    desStatusRequisicao: Autenticacao falhou
                    emailIndisponibilidade: radar@roraimaenergia.com.br
                    mensagem: API Key invalida ou expirada
                    interrupcaoFornecimento: []
        '429':
          description: Rate limit excedido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                idcStatusRequisicao: 2
                desStatusRequisicao: Rate limit excedido
                emailIndisponibilidade: radar@roraimaenergia.com.br
                mensagem: Maximo de 12 requisicoes por minuto atingido
                interrupcaoFornecimento: []
          headers:
            Retry-After:
              description: Segundos ate poder fazer nova requisicao
              schema:
                type: integer
                example: 60
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Servico indisponivel
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                idcStatusRequisicao: 2
                desStatusRequisicao: Servico indisponivel
                emailIndisponibilidade: radar@roraimaenergia.com.br
                mensagem: Banco de dados temporariamente indisponivel
                interrupcaoFornecimento: []

  /health:
    get:
      tags:
        - Health
      summary: Verifica saude da API
      description: |
        Retorna status de saude dos componentes da aplicacao.
        Nao requer autenticacao.
      operationId: healthCheck
      responses:
        '200':
          description: API saudavel
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: healthy
                database: true
                cache: true
                dblinks:
                  DBLINK_INSERVICE: true
                  DBLINK_INDICADORES: true
                version: "1.0.0"
        '503':
          description: API com problemas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: unhealthy
                database: false
                cache: true
                dblinks:
                  DBLINK_INSERVICE: false
                  DBLINK_INDICADORES: false
                version: "1.0.0"

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key
      description: |
        Chave de API para autenticacao.
        Solicite sua chave via email para radar@roraimaenergia.com.br

  schemas:
    InterrupcoesAtivasResponse:
      type: object
      required:
        - idcStatusRequisicao
        - desStatusRequisicao
        - emailIndisponibilidade
        - mensagem
        - interrupcaoFornecimento
      properties:
        idcStatusRequisicao:
          type: integer
          enum: [1, 2]
          description: |
            Codigo de status da requisicao:
            - 1: Sucesso
            - 2: Erro
          example: 1
        desStatusRequisicao:
          type: string
          description: Descricao do status
          example: Sucesso
        emailIndisponibilidade:
          type: string
          format: email
          description: Email para contato em caso de indisponibilidade
          example: radar@roraimaenergia.com.br
        mensagem:
          type: string
          description: Mensagem adicional (vazia em sucesso normal)
          example: ""
        interrupcaoFornecimento:
          type: array
          description: Lista de interrupcoes agregadas por municipio/conjunto
          items:
            $ref: '#/components/schemas/InterrupcaoFornecimento'

    InterrupcaoFornecimento:
      type: object
      required:
        - ideConjuntoUnidadeConsumidora
        - ideMunicipio
        - qtdUCsAtendidas
        - qtdOcorrenciaProgramada
        - qtdOcorrenciaNaoProgramada
      properties:
        ideConjuntoUnidadeConsumidora:
          type: integer
          description: Identificador do conjunto eletrico
          example: 1
        ideMunicipio:
          type: string
          pattern: '^14\d{5}$'
          description: Codigo IBGE do municipio (7 digitos, prefixo 14 para Roraima)
          example: "1400100"
        qtdUCsAtendidas:
          type: integer
          minimum: 0
          description: Quantidade total de UCs atendidas no conjunto/municipio
          example: 85432
        qtdOcorrenciaProgramada:
          type: integer
          minimum: 0
          description: Quantidade de UCs com interrupcao programada
          example: 234
        qtdOcorrenciaNaoProgramada:
          type: integer
          minimum: 0
          description: Quantidade de UCs com interrupcao nao programada
          example: 89

    ErrorResponse:
      type: object
      required:
        - idcStatusRequisicao
        - desStatusRequisicao
        - emailIndisponibilidade
        - mensagem
        - interrupcaoFornecimento
      properties:
        idcStatusRequisicao:
          type: integer
          enum: [2]
          description: Sempre 2 para erros
          example: 2
        desStatusRequisicao:
          type: string
          description: Descricao do erro
          example: Erro interno
        emailIndisponibilidade:
          type: string
          format: email
          example: radar@roraimaenergia.com.br
        mensagem:
          type: string
          description: Detalhes do erro
          example: Descricao detalhada do erro
        interrupcaoFornecimento:
          type: array
          description: Sempre vazio em caso de erro
          items: {}
          example: []

    HealthResponse:
      type: object
      required:
        - status
        - database
        - cache
        - dblinks
        - version
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          description: Status geral da aplicacao
        database:
          type: boolean
          description: Conexao com Oracle OK
        cache:
          type: boolean
          description: Cache em memoria OK
        dblinks:
          type: object
          additionalProperties:
            type: boolean
          description: Status de cada DBLink
        version:
          type: string
          description: Versao da API
          example: "1.0.0"
```

## Geracao Automatica

```python
# apps/api_interrupcoes/openapi.py
import yaml
from fastapi import FastAPI
from fastapi.openapi.utils import get_openapi


def generate_openapi_yaml(app: FastAPI, output_path: str) -> None:
    """Gera arquivo OpenAPI YAML a partir da aplicacao."""
    openapi_schema = get_openapi(
        title=app.title,
        version=app.version,
        description=app.description,
        routes=app.routes,
    )

    with open(output_path, "w") as f:
        yaml.dump(openapi_schema, f, default_flow_style=False, allow_unicode=True)


# Comando CLI
if __name__ == "__main__":
    from apps.api_interrupcoes.main import create_app

    app = create_app()
    generate_openapi_yaml(app, "docs/api-specs/openapi-api1-interrupcoes.yaml")
    print("OpenAPI spec generated successfully!")
```

## Testes TDD (Escrever PRIMEIRO)

```python
# tests/unit/openapi/test_openapi.py
import pytest
import yaml
from pathlib import Path

from fastapi import FastAPI
from fastapi.testclient import TestClient


class TestOpenAPISpec:
    """Testes para especificacao OpenAPI."""

    @pytest.fixture
    def spec_path(self):
        """Path do arquivo OpenAPI."""
        return Path("docs/api-specs/openapi-api1-interrupcoes.yaml")

    @pytest.fixture
    def spec(self, spec_path):
        """Carrega especificacao YAML."""
        with open(spec_path) as f:
            return yaml.safe_load(f)

    def test_deve_ser_openapi_3(self, spec):
        """Versao OpenAPI 3.0.x."""
        assert spec["openapi"].startswith("3.0")

    def test_deve_ter_info_completa(self, spec):
        """Info com titulo, descricao e versao."""
        info = spec["info"]

        assert "title" in info
        assert "description" in info
        assert "version" in info
        assert info["version"] == "1.0.0"

    def test_deve_ter_email_de_contato(self, spec):
        """Contato com email."""
        assert "contact" in spec["info"]
        assert "email" in spec["info"]["contact"]
        assert "roraimaenergia" in spec["info"]["contact"]["email"]

    def test_deve_ter_servers_definidos(self, spec):
        """Servers com producao e desenvolvimento."""
        assert "servers" in spec
        assert len(spec["servers"]) >= 1

        urls = [s["url"] for s in spec["servers"]]
        assert any("localhost" in url for url in urls)

    def test_deve_ter_endpoint_quantitativo(self, spec):
        """Endpoint principal documentado."""
        assert "/quantitativointerrupcoesativas" in spec["paths"]

        endpoint = spec["paths"]["/quantitativointerrupcoesativas"]
        assert "get" in endpoint

    def test_endpoint_deve_ter_security(self, spec):
        """Endpoint requer autenticacao."""
        endpoint = spec["paths"]["/quantitativointerrupcoesativas"]["get"]

        assert "security" in endpoint
        assert len(endpoint["security"]) > 0

    def test_deve_ter_todas_respostas_documentadas(self, spec):
        """Respostas 200, 401, 429, 500, 503 documentadas."""
        responses = spec["paths"]["/quantitativointerrupcoesativas"]["get"]["responses"]

        expected_codes = ["200", "401", "429", "500", "503"]
        for code in expected_codes:
            assert code in responses, f"Response {code} nao documentado"

    def test_deve_ter_health_endpoint(self, spec):
        """Endpoint /health documentado."""
        assert "/health" in spec["paths"]

    def test_health_nao_deve_requerer_auth(self, spec):
        """Health check nao requer autenticacao."""
        health = spec["paths"]["/health"]["get"]

        # Nao deve ter security ou deve estar vazio
        if "security" in health:
            assert health["security"] == []


class TestOpenAPISchemas:
    """Testes para schemas OpenAPI."""

    @pytest.fixture
    def spec(self):
        """Carrega especificacao YAML."""
        spec_path = Path("docs/api-specs/openapi-api1-interrupcoes.yaml")
        with open(spec_path) as f:
            return yaml.safe_load(f)

    def test_deve_ter_schema_interrupcoes_response(self, spec):
        """Schema InterrupcoesAtivasResponse definido."""
        schemas = spec["components"]["schemas"]

        assert "InterrupcoesAtivasResponse" in schemas

    def test_schema_response_deve_ter_campos_aneel(self, spec):
        """Response tem campos obrigatorios ANEEL."""
        schema = spec["components"]["schemas"]["InterrupcoesAtivasResponse"]
        props = schema["properties"]

        required_fields = [
            "idcStatusRequisicao",
            "desStatusRequisicao",
            "emailIndisponibilidade",
            "mensagem",
            "interrupcaoFornecimento",
        ]

        for field in required_fields:
            assert field in props, f"Campo {field} ausente"

    def test_deve_ter_schema_interrupcao_fornecimento(self, spec):
        """Schema InterrupcaoFornecimento definido."""
        schemas = spec["components"]["schemas"]

        assert "InterrupcaoFornecimento" in schemas

    def test_schema_interrupcao_deve_ter_campos_obrigatorios(self, spec):
        """Interrupcao tem campos obrigatorios."""
        schema = spec["components"]["schemas"]["InterrupcaoFornecimento"]
        props = schema["properties"]

        required_fields = [
            "ideConjuntoUnidadeConsumidora",
            "ideMunicipio",
            "qtdUCsAtendidas",
            "qtdOcorrenciaProgramada",
            "qtdOcorrenciaNaoProgramada",
        ]

        for field in required_fields:
            assert field in props, f"Campo {field} ausente"

    def test_deve_ter_schema_error_response(self, spec):
        """Schema ErrorResponse definido."""
        schemas = spec["components"]["schemas"]

        assert "ErrorResponse" in schemas

    def test_deve_ter_schema_health_response(self, spec):
        """Schema HealthResponse definido."""
        schemas = spec["components"]["schemas"]

        assert "HealthResponse" in schemas


class TestOpenAPISecurity:
    """Testes para seguranca OpenAPI."""

    @pytest.fixture
    def spec(self):
        """Carrega especificacao YAML."""
        spec_path = Path("docs/api-specs/openapi-api1-interrupcoes.yaml")
        with open(spec_path) as f:
            return yaml.safe_load(f)

    def test_deve_ter_security_scheme_api_key(self, spec):
        """Security scheme ApiKeyAuth definido."""
        security_schemes = spec["components"]["securitySchemes"]

        assert "ApiKeyAuth" in security_schemes

    def test_api_key_deve_ser_header(self, spec):
        """API Key no header x-api-key."""
        api_key_scheme = spec["components"]["securitySchemes"]["ApiKeyAuth"]

        assert api_key_scheme["type"] == "apiKey"
        assert api_key_scheme["in"] == "header"
        assert api_key_scheme["name"] == "x-api-key"


class TestOpenAPIExamples:
    """Testes para exemplos OpenAPI."""

    @pytest.fixture
    def spec(self):
        """Carrega especificacao YAML."""
        spec_path = Path("docs/api-specs/openapi-api1-interrupcoes.yaml")
        with open(spec_path) as f:
            return yaml.safe_load(f)

    def test_response_200_deve_ter_exemplos(self, spec):
        """Response 200 tem exemplos."""
        response = spec["paths"]["/quantitativointerrupcoesativas"]["get"]["responses"]["200"]

        content = response["content"]["application/json"]
        assert "examples" in content or "example" in content

    def test_response_401_deve_ter_exemplos(self, spec):
        """Response 401 tem exemplos."""
        response = spec["paths"]["/quantitativointerrupcoesativas"]["get"]["responses"]["401"]

        content = response["content"]["application/json"]
        assert "examples" in content or "example" in content
```

## Criterios de Aceite

- [ ] Testes escritos e passando
- [ ] OpenAPI 3.0.3 valido
- [ ] Todos os endpoints documentados
- [ ] Todos os schemas definidos
- [ ] Exemplos de requisicao e resposta
- [ ] Codigos de erro documentados
- [ ] Security scheme configurado
- [ ] Rate limiting documentado
- [ ] Swagger UI funcionando
- [ ] ReDoc funcionando
- [ ] Cobertura >= 80%

## Comando de Execucao

```bash
# Executar testes (RED)
pytest tests/unit/openapi/test_openapi.py -v

# Validar spec com ferramenta externa
openapi-spec-validator docs/api-specs/openapi-api1-interrupcoes.yaml
```

## Comandos

```bash
# Validar OpenAPI spec
openapi-spec-validator docs/api-specs/openapi-api1-interrupcoes.yaml

# Gerar spec a partir do codigo
python -m apps.api_interrupcoes.openapi

# Acessar Swagger UI (desenvolvimento)
open http://localhost:8001/docs

# Acessar ReDoc (desenvolvimento)
open http://localhost:8001/redoc
```

## Agentes Recomendados

- `@backend-architect` - Para revisar estrutura da API
